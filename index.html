<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cosmic Gem Clicker</title>
    <!-- Essential PWA Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="manifest" href="manifest.json">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0D1117; /* Dark background */
            color: #E6E8EA; /* Light text */
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .game-container {
            max-width: 1200px;
            width: 95%;
            padding: 1rem;
        }
        .dark-card {
            background-color: #161B22; /* Slightly lighter dark background for cards */
            border-radius: 0.75rem;
            padding: 1.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }
        .accent-button {
            background-color: #58a6ff;
            color: #0D1117;
            font-weight: 700;
            transition: all 0.1s;
        }
        .accent-button:hover {
            background-color: #79c0ff;
        }
        .upgrade-card {
            background-color: #380d0d; /* Dark red for upgrades */
            transition: transform 0.1s;
        }
        .upgrade-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 10px rgba(0, 0, 0, 0.5);
        }
        .prestige-button {
            background-color: #6a5acd; /* Crystal/Prestige color */
            color: white;
            transition: all 0.1s;
        }
        .prestige-button:hover:not(:disabled) {
            background-color: #8378d3;
        }
        .source-circle {
            width: 150px;
            height: 150px;
            background: linear-gradient(135deg, #ff8c00 0%, #ff4500 100%);
            border-radius: 50%;
            cursor: pointer;
            position: relative;
            box-shadow: 0 0 20px rgba(255, 69, 0, 0.7);
            transition: transform 0.1s, box-shadow 0.2s;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .source-circle:active {
            transform: scale(0.95);
            box-shadow: 0 0 10px rgba(255, 69, 0, 0.9);
        }
        .gem-icon {
            font-size: 3rem;
            color: #58a6ff;
            text-shadow: 0 0 10px rgba(88, 166, 255, 0.8);
        }
    </style>
</head>
<body class="p-4">

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // IMPORTANT: Set debug level for firestore
        setLogLevel('Debug');

        // Global variables provided by the environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'cosmic-gem-clicker-default';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app, db, auth;
        let userId = 'loading';
        let isAuthReady = false;
        let unsubscribeGameState = null;

        // Game State Management
        let gameState = {
            gems: 0,
            crystals: 0,
            clickPower: 1.0,
            minerLevel: 0,
            autoClickerLevel: 0,
            prestigeCount: 0,
            tutorialComplete: true,
            currentTab: 'gems' // To handle the two tabs
        };

        const PRESTIGE_THRESHOLD = 50000; // Gems required to unlock first crystal

        const GEM_COSTS = {
            click: (level) => Math.floor(10 * Math.pow(1.5, level)),
            miner: (level) => Math.floor(50 * Math.pow(2, level)),
            autoclicker: (level) => Math.floor(1000 * Math.pow(3, level)),
        };
        
        // --- Tab Management ---
        function switchTab(tabName) {
            gameState.currentTab = tabName;
            updateUI();
        }

        function getGemsPerSecond() {
            // Miner income: 0.1 G/sec per level
            let minerRate = gameState.minerLevel * 0.1;
            // Auto-Clicker income: 1 click/sec per level * clickPower
            let autoclickerRate = gameState.autoClickerLevel * gameState.clickPower * 1;
            
            // Apply prestige bonus: +1% income per crystal
            const prestigeMultiplier = 1 + (gameState.crystals * 0.01);

            return (minerRate + autoclickerRate) * prestigeMultiplier;
        }

        function getCrystalsPerSecond() {
            // Crystals are only generated on Prestige for this version
            return 0;
        }
        
        function calculateCrystalsOnPrestige() {
            // Formula: 1 Crystal for every 50,000 Gems earned in this run, after the first 50,000.
            if (gameState.gems < PRESTIGE_THRESHOLD) return 0;
            return Math.floor((gameState.gems - PRESTIGE_THRESHOLD) / 50000) + 1;
        }

        // UI Update Functions
        const $ = id => document.getElementById(id);

        function updateUI() {
            // Resources
            const gps = getGemsPerSecond();
            $('gems-amount').textContent = gameState.gems.toFixed(2);
            $('gems-rate').textContent = `Rate: ${gps.toFixed(2)} G/sec (x${(1 + (gameState.crystals * 0.01)).toFixed(2)} Multiplier)`;
            $('crystals-amount').textContent = gameState.crystals.toFixed(0);
            $('crystals-rate').textContent = `Total Prestige: ${gameState.prestigeCount}`;

            // --- Gem Upgrades Tab ---
            if (gameState.currentTab === 'gems') {
                $('upgrades-gems').classList.remove('hidden');
                $('upgrades-prestige').classList.add('hidden');
                $('tab-gems').classList.add('accent-button');
                $('tab-gems').classList.remove('bg-[#161B22]', 'text-gray-400');
                $('tab-prestige').classList.remove('accent-button');
                $('tab-prestige').classList.add('bg-[#161B22]', 'text-gray-400');

                // Click Source
                $('click-power').textContent = gameState.clickPower.toFixed(2);

                // Click Upgrades
                const nextClickCost = GEM_COSTS.click(gameState.clickPower - 1); // Click Power starts at 1
                $('enhance-level').textContent = `(Lvl ${gameState.clickPower.toFixed(0)})`;
                $('enhance-cost').textContent = nextClickCost.toLocaleString();
                $('enhance-buy').disabled = gameState.gems < nextClickCost;

                // Automation Upgrades
                const nextMinerCost = GEM_COSTS.miner(gameState.minerLevel);
                $('miner-level').textContent = `(Lvl ${gameState.minerLevel})`;
                $('miner-cost').textContent = nextMinerCost.toLocaleString();
                $('miner-income').textContent = `Generates ${ (gameState.minerLevel * 0.1).toFixed(2) } G/sec base.`;
                $('miner-buy').disabled = gameState.gems < nextMinerCost;

                const nextAutoClickerCost = GEM_COSTS.autoclicker(gameState.autoClickerLevel);
                $('autoclicker-level').textContent = `(Lvl ${gameState.autoClickerLevel})`;
                $('autoclicker-cost').textContent = nextAutoClickerCost.toLocaleString();
                $('autoclicker-income').textContent = `Simulates ${gameState.autoClickerLevel} clicks per second.`;
                $('autoclicker-buy').disabled = gameState.gems < nextAutoClickerCost;

            } 
            // --- Prestige Tab ---
            else if (gameState.currentTab === 'prestige') {
                $('upgrades-gems').classList.add('hidden');
                $('upgrades-prestige').classList.remove('hidden');
                $('tab-gems').classList.remove('accent-button');
                $('tab-gems').classList.add('bg-[#161B22]', 'text-gray-400');
                $('tab-prestige').classList.add('accent-button');
                $('tab-prestige').classList.remove('bg-[#161B22]', 'text-gray-400');
                
                // Prestige Button Logic
                const newCrystals = calculateCrystalsOnPrestige();
                $('prestige-new-crystals').textContent = newCrystals;
                $('prestige-current-gems').textContent = gameState.gems.toFixed(0);
                
                const isReady = gameState.gems >= PRESTIGE_THRESHOLD;
                $('prestige-btn').disabled = !isReady;
                $('prestige-requirement').classList.toggle('text-green-500', isReady);
                $('prestige-requirement').classList.toggle('text-red-500', !isReady);
            }


            // User ID
            $('player-id').textContent = userId;
            $('player-id-footer').textContent = userId;
        }

        // Game Logic Functions
        function clickGem() {
            gameState.gems += gameState.clickPower;
            updateUI();
            saveGameState(); // Save immediately on click for quick persistence
        }

        function buyUpgrade(type) {
            let cost;
            if (type === 'click') {
                cost = GEM_COSTS.click(gameState.clickPower - 1);
                if (gameState.gems >= cost) {
                    gameState.gems -= cost;
                    gameState.clickPower += 1.00;
                }
            } else if (type === 'miner') {
                cost = GEM_COSTS.miner(gameState.minerLevel);
                if (gameState.gems >= cost) {
                    gameState.gems -= cost;
                    gameState.minerLevel += 1;
                }
            } else if (type === 'autoclicker') {
                cost = GEM_COSTS.autoclicker(gameState.autoClickerLevel);
                if (gameState.gems >= cost) {
                    gameState.gems -= cost;
                    gameState.autoClickerLevel += 1;
                }
            }
            updateUI();
            saveGameState();
        }
        
        function performPrestige() {
            const newCrystals = calculateCrystalsOnPrestige();
            if (newCrystals > 0) {
                // 1. Gain Crystals
                gameState.crystals += newCrystals;
                gameState.prestigeCount += 1;
                
                // 2. Reset Gem State (keep crystals and prestige count)
                gameState.gems = 0;
                gameState.clickPower = 1.0;
                gameState.minerLevel = 0;
                gameState.autoClickerLevel = 0;
                
                // 3. Save and Update UI
                updateUI();
                saveGameState();
            } else {
                console.warn("Prestige failed: Not enough gems.");
            }
        }

        // Firebase Functions
        function getGameStateRef(id) {
            // Private data storage path: /artifacts/{appId}/users/{userId}/gameData/state
            return doc(db, 'artifacts', appId, 'users', id, 'gameData', 'state');
        }

        async function saveGameState() {
            if (!isAuthReady || !userId || !db) return;
            try {
                // Save the current state
                await setDoc(getGameStateRef(userId), gameState, { merge: true });
                // console.log("Game state saved successfully.");
            } catch (e) {
                console.error("Error saving document: ", e);
            }
        }

        function loadGameState(id) {
            if (unsubscribeGameState) {
                unsubscribeGameState(); // Unsubscribe from previous listener if changing user
            }

            // Set up real-time listener
            unsubscribeGameState = onSnapshot(getGameStateRef(id), (docSnapshot) => {
                if (docSnapshot.exists()) {
                    const loadedState = docSnapshot.data();
                    // Merge loaded state with default state to ensure all fields exist
                    gameState = { ...gameState, ...loadedState }; 
                    console.log("Game state loaded in real-time:", gameState);
                } else {
                    console.log("No existing game state found. Using initial state.");
                }
                updateUI();
            }, (error) => {
                console.error("Error listening to game state:", error);
            });
        }

        // Game Loop (for passive income)
        let lastUpdate = Date.now();
        function gameLoop() {
            const now = Date.now();
            const deltaTime = (now - lastUpdate) / 1000; // Time in seconds
            lastUpdate = now;

            if (isAuthReady) {
                const income = getGemsPerSecond() * deltaTime;
                gameState.gems += income;

                updateUI();
            }

            requestAnimationFrame(gameLoop);
        }

        // PWA & Auth Setup
        async function initApp() {
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // 1. Authenticate
                await new Promise((resolve) => {
                    onAuthStateChanged(auth, async (user) => {
                        if (user) {
                            userId = user.uid;
                        } else {
                            // Sign in anonymously if no token is provided or if state is lost
                            if (initialAuthToken) {
                                await signInWithCustomToken(auth, initialAuthToken);
                                userId = auth.currentUser.uid;
                            } else {
                                await signInAnonymously(auth);
                                userId = auth.currentUser.uid;
                            }
                        }
                        isAuthReady = true;
                        // console.log("Authentication Ready. User ID:", userId);
                        $('player-id').textContent = userId;
                        resolve();
                    });
                });

                // 2. Load Game State and Start Loop
                loadGameState(userId);
                gameLoop(); // Start the passive income loop

                // 3. Register Event Listeners
                $('source-circle').addEventListener('click', clickGem);
                $('enhance-buy').addEventListener('click', () => buyUpgrade('click'));
                $('miner-buy').addEventListener('click', () => buyUpgrade('miner'));
                $('autoclicker-buy').addEventListener('click', () => buyUpgrade('autoclicker'));
                
                // Tab Listeners
                $('tab-gems').addEventListener('click', () => switchTab('gems'));
                $('tab-prestige').addEventListener('click', () => switchTab('prestige'));
                
                // Prestige Listener
                $('prestige-btn').addEventListener('click', performPrestige);

            } catch (error) {
                console.error("Firebase/App Initialization Error:", error);
            }
        }

        window.onload = () => {
            initApp();

            // PWA Service Worker Registration
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('service-worker.js')
                    .then((reg) => console.log('Service Worker Registered (scope: ' + reg.scope + ')'))
                    .catch((err) => console.log('Service Worker Registration Failed:', err));
            }
        };

        // Export functions to window for HTML event listeners (though mostly handled by JS now)
        window.clickGem = clickGem;
    </script>


    <div class="game-container">
        <h1 class="text-4xl md:text-5xl font-extrabold text-center mb-4" style="color: #ff8c00; text-shadow: 0 0 10px rgba(255, 140, 0, 0.5);">Cosmic Gem Clicker</h1>
        <p id="player-id-display" class="text-center text-sm mb-6 text-gray-500">Player ID: <span id="player-id">Loading...</span></p>

        <!-- Resources Section (Flex on desktop, grid/stacked on mobile) -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-8">
            <!-- Gems Card -->
            <div class="dark-card">
                <h2 class="text-xl font-bold mb-2" style="color: #58a6ff;">Gems</h2>
                <div class="text-5xl font-extrabold" id="gems-amount">0</div>
                <p class="text-gray-400 mt-2 text-sm" id="gems-rate">Rate: 0.00 G/sec</p>
            </div>

            <!-- Crystals Card -->
            <div class="dark-card">
                <h2 class="text-xl font-bold mb-2" style="color: #6a5acd;">Crystals (Prestige Currency)</h2>
                <div class="text-5xl font-extrabold" id="crystals-amount">0</div>
                <p class="text-gray-400 mt-2 text-sm" id="crystals-rate">Total Prestige: 0</p>
            </div>
        </div>

        <!-- Main Game Area (Clicker & Upgrades) -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">

            <!-- Click Source Section -->
            <div class="dark-card col-span-1 flex flex-col items-center">
                <h2 class="text-xl font-bold mb-4">The Source</h2>
                <p class="text-lg mb-4 text-gray-300">Click Power: <span id="click-power">1.00</span> G/Click</p>

                <div id="source-circle" class="source-circle mb-4 flex-shrink-0">
                    <span class="gem-icon">ðŸ’Ž</span>
                </div>
                <p class="text-sm text-gray-500">Manual Click Income</p>
            </div>

            <!-- Upgrades Tab Selector -->
            <div class="lg:col-span-2">
                <div class="flex mb-4">
                    <button id="tab-gems" class="px-6 py-3 rounded-t-lg accent-button shadow-xl">Gem Upgrades</button>
                    <button id="tab-prestige" class="px-6 py-3 rounded-t-lg bg-[#161B22] text-gray-400 font-bold hover:bg-[#20252C]">Crystals & Prestige</button>
                </div>

                <!-- Upgrades Content CONTAINER -->
                <div class="dark-card">
                    <!-- Gem Upgrades Panel (Initially visible) -->
                    <div id="upgrades-gems">
                        <!-- Click Upgrades -->
                        <div class="mb-6">
                            <h3 class="text-2xl font-bold mb-4" style="color: #58a6ff;">Click Upgrades</h3>
                            <div id="click-upgrade" class="upgrade-card flex justify-between items-center p-4 rounded-lg">
                                <div>
                                    <h4 class="text-lg font-semibold text-white">Enhance Click Power <span id="enhance-level" class="text-sm text-gray-400">(Lvl 1)</span></h4>
                                    <p class="text-sm text-gray-400">Increases GEMS per click by 1.00.</p>
                                </div>
                                <div class="flex items-center space-x-2">
                                    <span id="enhance-cost" class="font-bold text-xl text-yellow-400">10</span>
                                    <span class="font-bold text-lg text-yellow-400">G</span>
                                    <button id="enhance-buy" class="px-4 py-2 bg-green-600 rounded-md font-bold hover:bg-green-700 disabled:opacity-50 disabled:cursor-not-allowed">Buy</button>
                                </div>
                            </div>
                        </div>

                        <!-- Automation Panel -->
                        <div>
                            <h3 class="text-2xl font-bold mb-4" style="color: #58a6ff;">Automation</h3>
                            <div class="space-y-4">
                                <!-- New Gem Miner -->
                                <div id="miner-upgrade" class="upgrade-card flex justify-between items-center p-4 rounded-lg">
                                    <div>
                                        <h4 class="text-lg font-semibold text-white">Buy New Gem Miner <span id="miner-level" class="text-sm text-gray-400">(Lvl 0)</span></h4>
                                        <p id="miner-income" class="text-sm text-gray-400">Generates 0.00 G/sec base.</p>
                                    </div>
                                    <div class="flex items-center space-x-2">
                                        <span id="miner-cost" class="font-bold text-xl text-yellow-400">50</span>
                                        <span class="font-bold text-lg text-yellow-400">G</span>
                                        <button id="miner-buy" class="px-4 py-2 bg-green-600 rounded-md font-bold hover:bg-green-700 disabled:opacity-50 disabled:cursor-not-allowed">Buy</button>
                                    </div>
                                </div>
                                <!-- Auto-Clicker -->
                                <div id="autoclicker-upgrade" class="upgrade-card flex justify-between items-center p-4 rounded-lg">
                                    <div>
                                        <h4 class="text-lg font-semibold text-white">Auto-Clicker <span id="autoclicker-level" class="text-sm text-gray-400">(Lvl 0)</span></h4>
                                        <p id="autoclicker-income" class="text-sm text-gray-400">Simulates 0 clicks per second.</p>
                                    </div>
                                    <div class="flex items-center space-x-2">
                                        <span id="autoclicker-cost" class="font-bold text-xl text-yellow-400">1,000</span>
                                        <span class="font-bold text-lg text-yellow-400">G</span>
                                        <button id="autoclicker-buy" class="px-4 py-2 bg-green-600 rounded-md font-bold hover:bg-green-700 disabled:opacity-50 disabled:cursor-not-allowed">Buy</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Prestige Upgrades Panel (Initially hidden) -->
                    <div id="upgrades-prestige" class="hidden text-center">
                        <h3 class="text-2xl font-bold mb-4" style="color: #6a5acd;">Prestige Protocol</h3>
                        <p class="text-lg mb-6 text-gray-300">
                            Prestige resets your Gems and Upgrades, but grants permanent Crystals.
                            Each Crystal increases all future Gem generation by <span class="font-bold text-green-400">1%</span>.
                        </p>
                        
                        <div class="mb-8 p-4 border border-gray-700 rounded-lg">
                            <p class="text-xl font-semibold mb-2">Gems Earned This Run: <span id="prestige-current-gems" class="text-yellow-400">0</span></p>
                            <p class="text-sm text-gray-400 mb-4">You need 50,000 Gems to perform Prestige.</p>
                            
                            <p id="prestige-requirement" class="text-3xl font-extrabold mb-6">
                                New Crystals to Earn: <span id="prestige-new-crystals">0</span> ðŸ’Ž
                            </p>
                            
                            <button id="prestige-btn" class="prestige-button px-8 py-3 rounded-xl font-extrabold text-lg disabled:opacity-50 disabled:cursor-not-allowed">
                                Initiate Prestige & Reset
                            </button>
                        </div>
                        
                        <p class="text-sm text-gray-500">Current Crystals: <span class="text-white font-bold" id="current-crystals-display">0</span> | Total Prestige Runs: <span class="text-white font-bold" id="prestige-count-display">0</span></p>
                    </div>
                </div>
            </div>
        </div>

        <p class="text-center text-xs text-gray-600 mt-8">
            Game State Version 2.2 | Real-time Persistence via Firestore (ID: <span id="player-id-footer">Loading...</span>)
        </p>

    </div>
</body>
</html>
