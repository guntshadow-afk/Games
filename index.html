<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cosmic Universal Idle</title>
    <!-- Essential PWA Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="manifest" href="manifest.json">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Tone.js for Sound Effects -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.min.js"></script>

    <style>
        /* General Layout & Dark Pastel Anime Theme */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #121825; /* Deepest Space Background */
            color: #E6E8EA;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            padding: 1rem;
            transition: background-color 0.5s;
            overflow-y: scroll;
        }

        /* Parallax Background Effect */
        .parallax-stars {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: -10;
        }
        .stars-1 {
            background-image: radial-gradient(circle, rgba(255, 255, 255, 0.8) 1px, transparent 1px);
            background-size: 500px 500px;
            animation: move-stars-1 150s linear infinite;
            opacity: 0.5;
        }
        .stars-2 {
            background-image: radial-gradient(circle, rgba(255, 255, 255, 0.4) 1px, transparent 1px);
            background-size: 300px 300px;
            animation: move-stars-2 100s linear infinite;
            opacity: 0.3;
        }
        @keyframes move-stars-1 { from { transform: translate(0, 0); } to { transform: translate(500px, 500px); } }
        @keyframes move-stars-2 { from { transform: translate(0, 0); } to { transform: translate(-300px, -300px); } }
        
        .game-container {
            max-width: 1200px;
            width: 100%;
        }
        .dark-card {
            background-color: #1E293B; /* Darker Card (Slate 800) */
            border-radius: 1rem;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.5);
            transition: transform 0.1s;
        }
        
        /* Accent Colors */
        .ce-color { color: #FF6F91; text-shadow: 0 0 5px #ff6f91; } /* Cosmic Energy (Pink Neon) */
        .sd-color { color: #B388FF; text-shadow: 0 0 5px #b388ff; } /* Stardust (Violet Pastel) */
        .gs-color { color: #80FFEA; text-shadow: 0 0 5px #80ffea; } /* Galaxy Shards (Cyan Neon) */
        .uf-color { color: #FFC478; text-shadow: 0 0 5px #ffc478; } /* Universal Fragments (Orange) */
        
        /* Interactive Elements */
        .accent-button {
            background-color: #4C51BF; /* Indigo 600 */
            color: #fff;
            font-weight: 700;
            transition: all 0.15s ease-out;
            box-shadow: 0 5px #3c4098;
            border-radius: 0.75rem;
        }
        .accent-button:hover:not(:disabled) { background-color: #5A60D9; }
        .accent-button:active:not(:disabled) { transform: translateY(3px); box-shadow: 0 2px #3c4098; }
        .accent-button:disabled { opacity: 0.4; cursor: not-allowed; box-shadow: none; transform: none;}

        /* Click Source Styling */
        .source-circle {
            width: 220px;
            height: 220px;
            background: radial-gradient(circle at 50% 50%, #FF6F91 0%, #B388FF 80%);
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 0 60px rgba(255, 111, 145, 0.9), 0 0 20px rgba(179, 136, 255, 0.7);
            transition: transform 0.1s, box-shadow 0.5s;
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 2rem auto;
            position: relative;
            user-select: none;
            touch-action: manipulation;
        }
        .source-circle:active { transform: scale(0.95); box-shadow: 0 0 30px rgba(255, 111, 145, 0.6), 0 0 10px rgba(179, 136, 255, 0.3); }
        .ce-symbol {
            font-size: 6rem;
            text-shadow: 0 0 15px #E6E8EA;
        }
        
        /* Mascot Animation */
        .mascot-container {
             animation: breath 4s ease-in-out infinite;
        }
        @keyframes breath {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.03); }
        }

        /* Floating Click Effect */
        .floating-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #80FFEA;
            font-size: 1.5rem;
            font-weight: 900;
            opacity: 1;
            animation: floatUp 1s ease-out forwards;
            pointer-events: none;
            z-index: 100;
        }
        @keyframes floatUp {
            0% { transform: translate(-50%, 0); opacity: 1; }
            100% { transform: translate(-50%, -200%); opacity: 0; font-size: 2rem; }
        }

        /* Upgrade Card Styling */
        .upgrade-card {
            background-color: #2D3748; /* Slate 700 */
            border: 1px solid #4C51BF;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }
        .upgrade-card:hover {
            background-color: #3b4559;
            box-shadow: 0 0 15px rgba(76, 81, 191, 0.5);
        }
        
        /* Tab Styling */
        .tab-button {
             flex-grow: 1;
             text-align: center;
             padding: 1rem;
             font-size: 1rem;
             background-color: #2D3748;
             color: #A0AEC0;
             border-radius: 0.75rem 0.75rem 0 0;
             transition: all 0.2s;
        }
        .tab-button.active {
            background-color: #1E293B;
            color: #80FFEA;
            border-bottom: 3px solid #80FFEA;
            font-weight: 700;
        }
        
        /* Achievement Pop-up */
        .achievement-popup {
            position: fixed;
            top: 1rem;
            right: 1rem;
            background-color: #10B981; /* Green 500 */
            color: white;
            padding: 1rem 1.5rem;
            border-radius: 0.75rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
            animation: slideIn 0.5s forwards, slideOut 0.5s 4.5s forwards;
            z-index: 900;
        }

        @keyframes slideIn {
            from { transform: translateX(150%); }
            to { transform: translateX(0); }
        }
        @keyframes slideOut {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(150%); opacity: 0; }
        }
    </style>
</head>
<body class="p-4">

    <!-- Parallax Background Layers -->
    <div class="parallax-stars stars-1"></div>
    <div class="parallax-stars stars-2"></div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, setDoc, collection, query, limit, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        setLogLevel('Debug');

        // --- GLOBAL & FIREBASE SETUP ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'cosmic-idle-default';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        const apiKey = ""; // API key for Gemini API is handled by Canvas environment
        const GEMINI_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

        let app, db, auth;
        let userId = 'loading';
        let isAuthReady = false;
        let unsubscribeGameState = null;
        let lastSaveTime = Date.now();
        let lastUpdate = Date.now();
        
        // Game Constants
        const AUTO_SAVE_INTERVAL = 5000;
        const LEADERBOARD_REFRESH_INTERVAL = 60000; // 1 minute
        const AUTO_UPGRADER_INTERVAL = 10000; // 10 seconds
        const EVENT_CHANCE_INTERVAL = 300000; // 5 minutes

        const PRESTIGE_COST = 1000000;
        const GALAXY_PRESTIGE_REQ = 10; // SD
        const UNIVERSAL_PRESTIGE_REQ = 5; // GS

        // Audio Setup
        const clickSynth = new Tone.PolySynth(Tone.Synth, {
            oscillator: { type: 'triangle' },
            envelope: { attack: 0.005, decay: 0.1, sustain: 0.0, release: 0.1 }
        }).toDestination();
        
        const achieveSynth = new Tone.PolySynth(Tone.Synth, {
             oscillator: { type: 'sine' },
             envelope: { attack: 0.01, decay: 0.2, sustain: 0.0, release: 0.5 }
        }).toDestination();
        
        // Global variables for game loop
        let nextAutoUpgradeTime = Date.now();
        let nextLeaderboardRefresh = Date.now();

        // Utility: Number Formatting
        function formatNumber(num) {
            if (num === null || num === undefined) return '0.00';
            if (Math.abs(num) < 1000) return num.toFixed(2);
            const SI_SYMBOL = ["", "K", "M", "B", "T", "Qa", "Qi", "Sx", "Sp", "Oc", "No", "Dc"];
            const tier = Math.floor(Math.log10(Math.abs(num)) / 3);
            if (tier === 0) return num.toFixed(0);
            const suffix = SI_SYMBOL[tier];
            const scale = Math.pow(10, tier * 3);
            const scaled = num / scale;
            return scaled.toFixed(2) + suffix;
        }
        
        function formatTime(seconds) {
            const h = Math.floor(seconds / 3600);
            const m = Math.floor((seconds % 3600) / 60);
            const s = Math.floor(seconds % 60);
            return `${h.toString().padStart(2, '0')}h ${m.toString().padStart(2, '0')}m ${s.toString().padStart(2, '0')}s`;
        }
        
        function playSFX(type) {
            if (gameState.isMuted) return;
            try {
                if (type === 'click') {
                    clickSynth.triggerAttackRelease(Tone.Midi(60 + Math.random() * 5), "8n");
                } else if (type === 'achieve') {
                    achieveSynth.triggerAttackRelease(["C5", "E5", "G5"], "4n");
                }
            } catch (e) {
                console.error("Audio error:", e);
            }
        }
        
        // --- GAME STATE ---
        let gameState = {
            ce: 0, stardust: 0, galaxyShards: 0, universalFragments: 0,
            cpcLevel: 0, cpcType2Level: 0, cpcType3Level: 0,
            cpsLevel: 0, cpsType2Level: 0, cpsType3Level: 0,
            
            prestigeCount: 0, galaxyPrestigeCount: 0,

            lastLogin: Date.now(),
            lastRewardClaim: 0, 
            dailyStreak: 0,

            autoClickerLevel: 0, autoUpgraderLevel: 0,
            
            petXP: 0, petLevel: 1, petEvolution: 0,
            
            achievements: {}, // { 'ACH_FIRST_CLICK': true, ... }
            
            currentEvent: null, // { type: 'BOOST_CE', multiplier: 5, endTime: 0 }
            nextEventTime: Date.now() + 300000, 
            
            lifetimeTaps: 0, totalCEEarned: 0, highestStreak: 0,

            isMuted: false,
            currentTab: 'shop',
            isLoaded: false,
        };
        
        let leaderboardData = [];
        const achievementsData = {
            'ACH_FIRST_CLICK': { name: 'First Light', desc: 'Click the core once.', check: () => gameState.lifetimeTaps >= 1 },
            'ACH_100_TAPS': { name: 'Tap Master', desc: 'Achieve 100 total taps.', check: () => gameState.lifetimeTaps >= 100 },
            'ACH_FIRST_PRESTIGE': { name: 'Rebirth', desc: 'Prestige for the first time.', check: () => gameState.prestigeCount >= 1 },
            'ACH_CE_1K': { name: 'Cosmic Hoarder', desc: 'Earn 1,000 Cosmic Energy.', check: () => gameState.totalCEEarned >= 1000 },
            'ACH_SD_10': { name: 'Star Catcher', desc: 'Possess 10 Stardust.', check: () => gameState.stardust >= 10 },
            'ACH_LVL_10_CPC': { name: 'Focused Lens', desc: 'Get Focus Lens to level 10.', check: () => gameState.cpcLevel >= 10 },
            'ACH_PET_EVO': { name: 'Cosmic Friend', desc: 'Evolve your pet once.', check: () => gameState.petEvolution >= 1 },
        };


        const UPGRADE_DATA = {
            cpc: { base: 1, multiplier: 1.5, increase: 1 }, 
            cpcType2: { base: 100, multiplier: 2.0, increase: 10 }, 
            cpcType3: { base: 10000, multiplier: 2.5, increase: 100 }, 
            
            cps: { base: 50, multiplier: 1.5, increase: 1 }, 
            cpsType2: { base: 5000, multiplier: 2.0, increase: 10 }, 
            cpsType3: { base: 500000, multiplier: 2.5, increase: 100 },
            
            // Automation
            autoClicker: { base: 1000, multiplier: 1.8, increase: 1 }, // CPS increase based on level
            autoUpgrader: { base: 10000, multiplier: 2.5, increase: 1 }, 
        };

        function getCost(level, type) {
            const data = UPGRADE_DATA[type];
            return Math.floor(data.base * Math.pow(data.multiplier, level));
        }

        // --- CALCULATIONS ---
        
        function applyPetBonus() {
            // Pet gives 1% CPC/CPS per level
            return 1 + (gameState.petLevel * 0.01);
        }

        function applyEventMultiplier() {
            if (gameState.currentEvent && gameState.currentEvent.endTime > Date.now()) {
                return gameState.currentEvent.multiplier;
            }
            return 1;
        }

        function calculateCPC() {
            let baseCPC = 1;
            baseCPC += gameState.cpcLevel * UPGRADE_DATA.cpc.increase;
            baseCPC += gameState.cpcType2Level * UPGRADE_DATA.cpcType2.increase;
            baseCPC += gameState.cpcType3Level * UPGRADE_DATA.cpcType3.increase;
            
            // Total Multipliers
            const petBonus = applyPetBonus();
            const eventBonus = applyEventMultiplier();
            
            return baseCPC * petBonus * eventBonus;
        }

        function calculateCPS() {
            let baseCPS = 0;
            baseCPS += gameState.cpsLevel * UPGRADE_DATA.cps.increase;
            baseCPS += gameState.cpsType2Level * UPGRADE_DATA.cpsType2.increase;
            baseCPS += gameState.cpsType3Level * UPGRADE_DATA.cpsType3.increase;
            
            // --- GLOBAL MULTIPLIERS ---
            const stardustMultiplier = 1 + (gameState.stardust * 0.05); // T1
            const shardMultiplier = 1 + (gameState.galaxyShards * 0.1); // T2
            const fragmentMultiplier = 1 + (gameState.universalFragments * 0.2); // T3
            const petBonus = applyPetBonus();
            const eventBonus = applyEventMultiplier();
            
            return baseCPS * stardustMultiplier * shardMultiplier * fragmentMultiplier * petBonus * eventBonus;
        }
        
        function calculateAutoClickerCPC() {
            // Auto-clicker contributes 10% of current manual CPC per level
            const manualCPC = calculateCPC();
            return manualCPC * (gameState.autoClickerLevel * 0.1);
        }

        function calculateStardustOnPrestige() {
            if (gameState.ce < PRESTIGE_COST) return 0;
            return Math.floor(Math.log10(gameState.ce / PRESTIGE_COST)) + 1;
        }
        
        function calculateGalaxyShardsOnPrestige() {
            if (gameState.stardust < GALAXY_PRESTIGE_REQ) return 0;
            return Math.floor(gameState.stardust / GALAXY_PRESTIGE_REQ);
        }
        
        function calculateUniversalFragmentsOnPrestige() {
            if (gameState.galaxyShards < UNIVERSAL_PRESTIGE_REQ) return 0;
            return Math.floor(gameState.galaxyShards / UNIVERSAL_PRESTIGE_REQ);
        }

        // --- UI UTILITIES ---
        const $ = id => document.getElementById(id);

        function updateUI() {
            const cpc = calculateCPC();
            const cps = calculateCPS();
            const autoCpc = calculateAutoClickerCPC();

            // --- HEADER RESOURCES ---
            $('ce-amount').textContent = formatNumber(gameState.ce);
            $('cpc-amount').textContent = formatNumber(cpc);
            $('cps-amount').textContent = formatNumber(cps);
            
            $('stardust-amount').textContent = formatNumber(gameState.stardust);
            $('shards-amount').textContent = formatNumber(gameState.galaxyShards);
            $('fragments-amount').textContent = formatNumber(gameState.universalFragments);
            
            // --- EVENT DISPLAY ---
            updateEventUI();

            // --- TAB NAVIGATION ---
            ['shop', 'automation', 'pets', 'prestige', 'achievements', 'leaderboard', 'stats'].forEach(tabName => {
                const isSelected = gameState.currentTab === tabName;
                $(`tab-${tabName}`).classList.toggle('active', isSelected);
                $(`panel-${tabName}`).classList.toggle('hidden', !isSelected);
            });
            
            // --- UPDATE ACTIVE PANEL ---
            if (gameState.currentTab === 'shop') updateShopUI();
            if (gameState.currentTab === 'automation') updateAutomationUI(autoCpc);
            if (gameState.currentTab === 'pets') updatePetsUI();
            if (gameState.currentTab === 'prestige') updatePrestigeUI();
            if (gameState.currentTab === 'achievements') updateAchievementsUI();
            if (gameState.currentTab === 'stats') updateStatsUI();
            if (gameState.currentTab === 'leaderboard') renderLeaderboard();
        }

        function updateEventUI() {
            const eventContainer = $('event-container');
            const now = Date.now();

            if (gameState.currentEvent && gameState.currentEvent.endTime > now) {
                eventContainer.classList.remove('hidden');
                const remainingTime = (gameState.currentEvent.endTime - now) / 1000;
                $('event-desc').textContent = `Cosmic Boost: ${gameState.currentEvent.multiplier}x CE Multiplier!`;
                $('event-timer').textContent = formatTime(remainingTime);
            } else {
                eventContainer.classList.add('hidden');
            }
        }
        
        // --- PANEL SPECIFIC UI UPDATES ---

        function updateShopUI() {
            updateUpgradeCard('cpc', 'Focus Lens', 'cpcLevel', 'Increases click power by +1 CE.', 'Buy-1', 'Buy');
            updateUpgradeCard('cpcType2', 'Quantum Tap', 'cpcType2Level', 'Increases click power by +10 CE.', 'Buy-2', 'Buy');
            updateUpgradeCard('cpcType3', 'Singularity Click', 'cpcType3Level', 'Increases click power by +100 CE.', 'Buy-3', 'Buy');

            updateUpgradeCard('cps', 'Solar Panel', 'cpsLevel', 'Increases passive income by +1 CPS.', 'Buy-4', 'Buy');
            updateUpgradeCard('cpsType2', 'Asteroid Miner', 'cpsType2Level', 'Increases passive income by +10 CPS.', 'Buy-5', 'Buy');
            updateUpgradeCard('cpsType3', 'Dyson Sphere', 'cpsType3Level', 'Increases passive income by +100 CPS.', 'Buy-6', 'Buy');
        }
        
        function updateAutomationUI(autoCpc) {
            updateUpgradeCard('autoClicker', 'Auto-Tapper Bot', 'autoClickerLevel', `Taps automatically, adding +${formatNumber(autoCpc)} CE/s.`, 'Buy-Auto-1', 'Upgrade');
            updateUpgradeCard('autoUpgrader', 'Auto-Shop Bot', 'autoUpgraderLevel', `Automatically buys the cheapest available upgrade every 10s.`, 'Buy-Auto-2', 'Upgrade');
            
            // Auto Clicker CPS Display
            $('auto-cpc-display').textContent = formatNumber(autoCpc);
            $('auto-upgrader-status').textContent = gameState.autoUpgraderLevel > 0 ? `Active (Level ${gameState.autoUpgraderLevel})` : 'Inactive';
        }
        
        function updatePetsUI() {
            // Pet Info
            const petNames = ['Cosmic Spark', 'Star Chaser', 'Nebula Dragon'];
            const petImage = [
                'https://placehold.co/150x150/1A202C/FFC478?text=Spark',
                'https://placehold.co/150x150/1A202C/FF6F91?text=Chaser',
                'https://placehold.co/150x150/1A202C/B388FF?text=Dragon'
            ];
            
            $('pet-name').textContent = petNames[gameState.petEvolution % petNames.length];
            $('pet-image').src = petImage[gameState.petEvolution % petNames.length];
            $('pet-level').textContent = gameState.petLevel;
            $('pet-xp').textContent = formatNumber(gameState.petXP);
            $('pet-bonus').textContent = `${(applyPetBonus() * 100 - 100).toFixed(0)}%`;
            
            const xpNeeded = gameState.petLevel * 100;
            $('pet-xp-needed').textContent = formatNumber(xpNeeded);
            $('pet-xp-bar').style.width = `${Math.min(100, (gameState.petXP / xpNeeded) * 100)}%`;
            
            // Evolution logic (simplified: every 10 levels)
            const canEvolve = gameState.petLevel >= 10 && gameState.petEvolution < petNames.length - 1;
            $('pet-evolve-btn').disabled = !canEvolve;
            $('pet-evolve-desc').textContent = canEvolve ? 'Ready for next form!' : `Needs Level 10 for Evolution ${gameState.petEvolution + 2}.`;
        }

        function updatePrestigeUI() {
             // Tier 1
            const newSD = calculateStardustOnPrestige();
            $('prestige-1-sd').textContent = newSD;
            $('prestige-1-btn').disabled = newSD === 0;
            $('prestige-1-req').textContent = formatNumber(PRESTIGE_COST);
            $('prestige-1-req-color').classList.toggle('text-green-400', newSD > 0);
            $('prestige-1-req-color').classList.toggle('text-red-400', newSD === 0);
            $('prestige-1-multiplier').textContent = `x${formatNumber(1 + (gameState.stardust * 0.05))}`;

            // Tier 2 (Galaxy Shards)
            const newGS = calculateGalaxyShardsOnPrestige();
            $('prestige-2-gs').textContent = newGS;
            $('prestige-2-btn').disabled = newGS === 0;
            $('prestige-2-req').textContent = GALAXY_PRESTIGE_REQ;
            $('prestige-2-req-color').classList.toggle('text-green-400', newGS > 0);
            $('prestige-2-req-color').classList.toggle('text-red-400', newGS === 0);

            // Tier 3 (Universal Fragments)
            const newUF = calculateUniversalFragmentsOnPrestige();
            $('prestige-3-uf').textContent = newUF;
            $('prestige-3-btn').disabled = newUF === 0;
            $('prestige-3-req').textContent = UNIVERSAL_PRESTIGE_REQ;
            $('prestige-3-req-color').classList.toggle('text-green-400', newUF > 0);
            $('prestige-3-req-color').classList.toggle('text-red-400', newUF === 0);
        }
        
        function updateAchievementsUI() {
            const container = $('achievements-list');
            container.innerHTML = '';
            
            Object.keys(achievementsData).forEach(key => {
                const achieved = gameState.achievements[key];
                const data = achievementsData[key];
                
                const card = document.createElement('div');
                card.className = `p-4 rounded-xl shadow-lg transition-all ${achieved ? 'bg-green-800/50 border-2 border-green-400' : 'bg-gray-700/50 border border-gray-600'}`;
                card.innerHTML = `
                    <h5 class="text-xl font-bold ${achieved ? 'text-green-300' : 'text-gray-300'}">${data.name}</h5>
                    <p class="text-sm text-gray-400">${data.desc}</p>
                    <span class="text-xs font-semibold mt-2 inline-block ${achieved ? 'text-green-400' : 'text-yellow-400'}">
                        ${achieved ? 'UNLOCKED' : 'LOCKED'}
                    </span>
                `;
                container.appendChild(card);
            });
        }
        
        function updateStatsUI() {
            $('stat-prestige-runs').textContent = formatNumber(gameState.prestigeCount);
            $('stat-galaxy-runs').textContent = formatNumber(gameState.galaxyPrestigeCount);
            $('stat-stardust').textContent = formatNumber(gameState.stardust);
            $('stat-shards').textContent = formatNumber(gameState.galaxyShards);
            $('stat-lifetime-taps').textContent = formatNumber(gameState.lifetimeTaps);
            $('stat-total-ce').textContent = formatNumber(gameState.totalCEEarned);
            $('stat-highest-streak').textContent = gameState.highestStreak;
            $('stat-event-count').textContent = 'N/A'; // Placeholder
        }

        function updateUpgradeCard(type, name, levelKey, description, buttonId, buttonText) {
            const level = gameState[levelKey];
            const cost = getCost(level, type);
            const isAffordable = gameState.ce >= cost;

            $(`${type}-title`).textContent = `${name} (Lvl ${level})`;
            $(`${type}-desc`).textContent = description;
            
            const costSpan = $(`${type}-cost`);
            costSpan.textContent = formatNumber(cost);
            costSpan.className = `font-bold text-xl ${isAffordable ? 'text-yellow-400' : 'text-red-500'}`;
            
            const buyButton = $(buttonId);
            buyButton.textContent = buttonText;
            buyButton.disabled = !isAffordable;
            
            if (!buyButton.hasAttribute('data-listener-added')) {
                buyButton.addEventListener('click', () => buyUpgrade(type, levelKey));
                buyButton.setAttribute('data-listener-added', 'true');
            }
        }
        
        function renderLeaderboard() {
            const container = $('leaderboard-list');
            container.innerHTML = '';
            
            if (leaderboardData.length === 0) {
                 container.innerHTML = `<p class="text-center text-gray-400">Loading Leaderboard data...</p>`;
                 return;
            }
            
            leaderboardData.forEach((player, index) => {
                const rank = index + 1;
                const isYou = player.userId === userId;
                const card = document.createElement('div');
                card.className = `p-3 rounded-lg flex justify-between items-center text-lg ${isYou ? 'bg-indigo-600/50 border border-indigo-400 font-bold' : 'bg-gray-700/50 border border-gray-600'}`;
                
                card.innerHTML = `
                    <span class="w-1/12 text-center text-xl gs-color">#${rank}</span>
                    <span class="w-4/12 truncate text-sm">${player.userId}</span>
                    <span class="w-3/12 text-center sd-color">${formatNumber(player.stardust)} SD</span>
                    <span class="w-4/12 text-right ce-color">${formatNumber(player.ce)} CE</span>
                `;
                container.appendChild(card);
            });
        }


        // --- GAME LOGIC ---
        
        function checkAchievements() {
            Object.keys(achievementsData).forEach(key => {
                if (!gameState.achievements[key] && achievementsData[key].check()) {
                    gameState.achievements[key] = true;
                    showAchievementPopup(achievementsData[key].name);
                    playSFX('achieve');
                }
            });
        }

        function showAchievementPopup(name) {
            const popup = $('achievement-popup');
            popup.textContent = `ðŸ† Achievement Unlocked: ${name}!`;
            popup.classList.add('animate-slideIn');
            popup.classList.remove('hidden');
            
            setTimeout(() => {
                popup.classList.remove('animate-slideIn');
                popup.classList.add('animate-slideOut');
                setTimeout(() => popup.classList.add('hidden'), 500);
            }, 4500);
        }

        function clickCE(event) {
            playSFX('click');
            const cpc = calculateCPC();
            gameState.ce += cpc;
            gameState.totalCEEarned += cpc;
            gameState.lifetimeTaps += 1;
            gameState.petXP += 1;

            updatePetLevel();
            updateUI();
            
            // Floating Text Effect
            const clickSource = $('source-circle');
            const rect = clickSource.getBoundingClientRect();
            
            const float = document.createElement('div');
            float.className = 'floating-text';
            float.textContent = `+${formatNumber(cpc)}`;
            
            float.style.left = event ? `${event.clientX - rect.left}px` : '50%';
            float.style.top = event ? `${event.clientY - rect.top}px` : '50%';

            clickSource.appendChild(float);
            setTimeout(() => float.remove(), 1000);
            
            checkAchievements();
            saveGameState(); 
        }

        function buyUpgrade(type, levelKey) {
            const level = gameState[levelKey];
            const cost = getCost(level, type);

            if (gameState.ce >= cost) {
                gameState.ce -= cost;
                gameState[levelKey] += 1;
                updateUI();
                checkAchievements();
                saveGameState(); 
            }
        }
        
        function autoUpgrade() {
            if (gameState.autoUpgraderLevel === 0) return;
            
            const upgradeTypes = Object.keys(UPGRADE_DATA).filter(k => k !== 'autoUpgrader' && k !== 'autoClicker');
            let cheapestUpgrade = null;
            let minCost = Infinity;

            for (const type of upgradeTypes) {
                const levelKey = Object.keys(gameState).find(k => k.startsWith(type) && k.endsWith('Level')) || type + 'Level';
                const cost = getCost(gameState[levelKey], type);
                
                if (cost < minCost && gameState.ce >= cost) {
                    minCost = cost;
                    cheapestUpgrade = { type, levelKey };
                }
            }
            
            if (cheapestUpgrade) {
                buyUpgrade(cheapestUpgrade.type, cheapestUpgrade.levelKey);
                console.log(`Auto-Upgrader bought: ${cheapestUpgrade.type}`);
            }
        }

        // --- PET LOGIC ---
        function updatePetLevel() {
            const xpNeeded = gameState.petLevel * 100;
            while (gameState.petXP >= xpNeeded) {
                gameState.petXP -= xpNeeded;
                gameState.petLevel += 1;
                // Pet level up sound?
                console.log(`Pet Leveled up to ${gameState.petLevel}`);
            }
        }
        
        function evolvePet() {
            const petNames = ['Cosmic Spark', 'Star Chaser', 'Nebula Dragon'];
            if (gameState.petLevel >= 10 && gameState.petEvolution < petNames.length - 1) {
                gameState.petEvolution += 1;
                gameState.petLevel = 1;
                gameState.petXP = 0;
                checkAchievements();
                updateUI();
                saveGameState();
            }
        }

        // --- PRESTIGE LOGIC ---
        function prestigeTier1() {
            const newSD = calculateStardustOnPrestige();
            if (newSD > 0) {
                gameState.stardust += newSD;
                gameState.prestigeCount += 1;
                
                // Reset
                gameState.ce = 0;
                gameState.cpcLevel = 0; gameState.cpcType2Level = 0; gameState.cpcType3Level = 0;
                gameState.cpsLevel = 0; gameState.cpsType2Level = 0; gameState.cpsType3Level = 0;
                gameState.autoClickerLevel = 0; gameState.autoUpgraderLevel = 0;
                
                checkAchievements();
                switchTab('prestige');
                updateUI();
                saveGameState(true);
            }
        }

        function prestigeTier2() {
            const newGS = calculateGalaxyShardsOnPrestige();
            if (newGS > 0) {
                gameState.galaxyShards += newGS;
                gameState.galaxyPrestigeCount += 1;
                
                // Reset T1 + Game State
                gameState.stardust = 0;
                gameState.ce = 0;
                gameState.cpcLevel = 0; gameState.cpcType2Level = 0; gameState.cpcType3Level = 0;
                gameState.cpsLevel = 0; gameState.cpsType2Level = 0; gameState.cpsType3Level = 0;
                gameState.autoClickerLevel = 0; gameState.autoUpgraderLevel = 0;

                switchTab('prestige');
                updateUI();
                saveGameState(true);
            }
        }

        function prestigeTier3() {
            const newUF = calculateUniversalFragmentsOnPrestige();
            if (newUF > 0) {
                gameState.universalFragments += newUF;
                
                // Reset ALL but fragments
                gameState.galaxyShards = 0;
                gameState.stardust = 0;
                gameState.ce = 0;
                gameState.cpcLevel = 0; gameState.cpcType2Level = 0; gameState.cpcType3Level = 0;
                gameState.cpsLevel = 0; gameState.cpsType2Level = 0; gameState.cpsType3Level = 0;
                gameState.autoClickerLevel = 0; gameState.autoUpgraderLevel = 0;

                switchTab('prestige');
                updateUI();
                saveGameState(true);
            }
        }
        
        // --- DAILY REWARD LOGIC ---
        function checkDailyReward() {
            const today = new Date().toDateString();
            const lastClaim = new Date(gameState.lastRewardClaim).toDateString();
            
            if (today !== lastClaim) {
                const yesterday = new Date(Date.now() - 86400000).toDateString(); // 24 hours ago
                
                if (lastClaim === yesterday) {
                    // Streak continues
                    gameState.dailyStreak += 1;
                } else {
                    // Streak broken
                    gameState.dailyStreak = 1;
                }
                
                const reward = gameState.dailyStreak * 1000 + 1000;
                gameState.ce += reward;
                gameState.lastRewardClaim = Date.now();
                gameState.highestStreak = Math.max(gameState.highestStreak, gameState.dailyStreak);

                showDailyRewardModal(reward, gameState.dailyStreak);
                saveGameState();
            }
        }
        
        function showDailyRewardModal(amount, streak) {
            const modal = $('daily-reward-modal');
            $('reward-amount').textContent = formatNumber(amount);
            $('reward-streak').textContent = streak;
            modal.classList.remove('hidden');
        }
        
        function dismissDailyRewardModal() {
            $('daily-reward-modal').classList.add('hidden');
        }

        // --- COSMIC EVENT LOGIC ---
        function checkCosmicEvent() {
            const now = Date.now();

            // 1. End active event if time is up
            if (gameState.currentEvent && gameState.currentEvent.endTime <= now) {
                gameState.currentEvent = null;
                console.log("Cosmic event ended.");
                // Set next event time randomly between 5 to 15 minutes
                gameState.nextEventTime = now + (300000 + Math.random() * 600000); 
                generateMascotTip("The cosmic anomaly has subsided. Time to get back to regular mining!");
                updateUI();
                return;
            }

            // 2. Start a new event if ready
            if (!gameState.currentEvent && gameState.nextEventTime <= now) {
                const multiplier = Math.floor(Math.random() * 5) + 2; // 2x to 6x
                const duration = 60000 + Math.random() * 180000; // 1 to 3 minutes
                
                gameState.currentEvent = {
                    type: 'BOOST_CE',
                    multiplier: multiplier,
                    endTime: now + duration
                };
                
                generateMascotTip(`Alert! A Stellar Flare has erupted! All CE earnings are currently boosted by ${multiplier}x for ${formatTime(duration/1000)}!`);
                updateUI();
            }
        }

        // --- AI MASCOT LOGIC (Simulated Gemini API Call) ---
        async function generateMascotTip(systemTip = null) {
            const mascotText = $('mascot-text');
            const mascotLoader = $('mascot-loader');
            
            mascotText.textContent = systemTip || "Stardew is thinking...";
            mascotLoader.classList.remove('hidden');

            if (systemTip) {
                mascotLoader.classList.add('hidden');
                return; 
            }

            const prompt = `Act as an encouraging anime cosmic pet named Stardew. You give a concise, single-sentence tip about the game. The player has ${formatNumber(gameState.ce)} CE and ${gameState.stardust} Stardust. Current CPC is ${formatNumber(calculateCPC())}.`;
            
            // Simplified Exponential Backoff for retries
            for (let i = 0; i < 3; i++) {
                try {
                    const payload = {
                        contents: [{ parts: [{ text: prompt }] }],
                        systemInstruction: { parts: [{ text: "You are Stardew, an anime cosmic pet. Your response must be short, encouraging, and provide one game tip or observation." }] },
                    };

                    const response = await fetch(GEMINI_API_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    
                    const result = await response.json();
                    const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
                    
                    if (text) {
                        mascotText.textContent = text;
                        break; 
                    }
                } catch (error) {
                    console.warn(`Attempt ${i + 1} failed: ${error.message}. Retrying...`);
                    await new Promise(res => setTimeout(res, Math.pow(2, i) * 1000)); // Exponential backoff
                }
            }
            mascotLoader.classList.add('hidden');
        }

        // --- FIREBASE PERSISTENCE ---

        function getGameStateRef(id) {
            return doc(db, 'artifacts', appId, 'users', id, 'gameData', 'state');
        }
        
        function getLeaderboardCollection() {
             // Public collection for global data
             return collection(db, 'artifacts', appId, 'public', 'data', 'leaderboard');
        }

        async function saveGameState(manual = false) {
            if (!isAuthReady || !userId || !db) return;
            const now = Date.now();
            
            if (!manual && (now - lastSaveTime < AUTO_SAVE_INTERVAL)) return;

            gameState.lastLogin = now;
            try {
                await setDoc(getGameStateRef(userId), gameState, { merge: true });
                lastSaveTime = now;
                
                // Update Leaderboard Data
                await setDoc(doc(getLeaderboardCollection(), userId), {
                    userId: userId,
                    ce: gameState.ce,
                    stardust: gameState.stardust,
                    timestamp: now
                }, { merge: true });

            } catch (e) {
                console.error("Error saving document: ", e);
            }
        }
        
        async function fetchLeaderboard() {
             if (!db || !isAuthReady) return;
             
             try {
                 // Simulate fetching top 100 players ordered by Stardust, then CE
                 const q = query(getLeaderboardCollection(), limit(10)); 
                 const snapshot = await getDocs(q);
                 
                 let data = snapshot.docs.map(doc => doc.data());
                 
                 // Manual sort (since we avoid orderBy)
                 data.sort((a, b) => {
                     if (b.stardust !== a.stardust) {
                         return b.stardust - a.stardust;
                     }
                     return b.ce - a.ce;
                 });
                 
                 leaderboardData = data;
                 if (gameState.currentTab === 'leaderboard') renderLeaderboard();

             } catch (e) {
                 console.error("Error fetching leaderboard:", e);
             }
        }


        function calculateOfflineEarnings(loadedState) {
            const now = Date.now();
            const lastLogin = loadedState.lastLogin || now;
            const offlineDurationSeconds = (now - lastLogin) / 1000;

            if (offlineDurationSeconds > 1) { 
                const temporaryState = { ...loadedState }; 
                
                const tempStateCPS = (function(state) {
                    let baseCPS = 0;
                    baseCPS += state.cpsLevel * UPGRADE_DATA.cps.increase;
                    baseCPS += state.cpsType2Level * UPGRADE_DATA.cpsType2.increase;
                    baseCPS += state.cpsType3Level * UPGRADE_DATA.cpsType3.increase;
                    const stardustMultiplier = 1 + (state.stardust * 0.05);
                    const shardMultiplier = 1 + (state.galaxyShards * 0.1); 
                    const fragmentMultiplier = 1 + (state.universalFragments * 0.2); 
                    const petBonus = 1 + (state.petLevel * 0.01);
                    return baseCPS * stardustMultiplier * shardMultiplier * fragmentMultiplier * petBonus;
                })(temporaryState);

                const earnedCE = tempStateCPS * offlineDurationSeconds;
                
                if (earnedCE > 0) {
                    showOfflineModal(offlineDurationSeconds, earnedCE);
                    return earnedCE;
                }
            }
            return 0;
        }

        function showOfflineModal(duration, amount) {
            const modal = $('offline-modal');
            const durationFormatted = formatTime(duration);
            
            $('offline-duration').textContent = durationFormatted;
            $('offline-amount').textContent = formatNumber(amount);
            
            modal.classList.remove('hidden');
        }
        
        function dismissOfflineModal() {
            $('offline-modal').classList.add('hidden');
        }

        function loadGameState(id) {
            if (unsubscribeGameState) {
                unsubscribeGameState(); 
            }

            unsubscribeGameState = onSnapshot(getGameStateRef(id), (docSnapshot) => {
                const now = Date.now();
                
                if (docSnapshot.exists()) {
                    const loadedState = docSnapshot.data();
                    
                    if (!gameState.isLoaded) {
                        const earned = calculateOfflineEarnings(loadedState);
                        gameState = { ...gameState, ...loadedState, isLoaded: true };
                        gameState.ce = loadedState.ce + earned; 
                    } else {
                        // Merge subsequent real-time updates
                        gameState = { ...gameState, ...loadedState };
                    }
                    
                    checkDailyReward();
                    updateUI();
                    lastUpdate = now;
                } else {
                    if (!gameState.isLoaded) {
                        gameState.isLoaded = true;
                        checkDailyReward();
                        updateUI();
                    }
                    console.log("No existing game state found. Using initial state.");
                }
            }, (error) => {
                console.error("Error listening to game state:", error);
            });
        }
        
        function resetGame() {
             $('reset-modal').classList.remove('hidden');
        }

        function confirmReset() {
            gameState = {
                ce: 0, stardust: 0, galaxyShards: 0, universalFragments: 0,
                cpcLevel: 0, cpcType2Level: 0, cpcType3Level: 0,
                cpsLevel: 0, cpsType2Level: 0, cpsType3Level: 0,
                prestigeCount: 0, galaxyPrestigeCount: 0,
                lastLogin: Date.now(), lastRewardClaim: 0, dailyStreak: 0,
                autoClickerLevel: 0, autoUpgraderLevel: 0,
                petXP: 0, petLevel: 1, petEvolution: 0,
                achievements: {}, 
                currentEvent: null, nextEventTime: Date.now() + 300000,
                lifetimeTaps: 0, totalCEEarned: 0, highestStreak: 0,
                isMuted: gameState.isMuted, currentTab: 'shop', isLoaded: true,
            };
            saveGameState(true);
            dismissResetModal();
            updateUI();
        }

        function dismissResetModal() {
            $('reset-modal').classList.add('hidden');
        }

        function toggleMute() {
            gameState.isMuted = !gameState.isMuted;
            $('mute-btn').textContent = gameState.isMuted ? 'ðŸ”Š Unmute' : 'ðŸ”‡ Mute';
            saveGameState(true);
        }

        // --- GAME LOOP ---
        function gameLoop() {
            const now = Date.now();
            const deltaTime = (now - lastUpdate) / 1000; 
            lastUpdate = now;

            if (isAuthReady && gameState.isLoaded) {
                // 1. Passive Income (CPS)
                const cps = calculateCPS();
                const income = cps * deltaTime;
                gameState.ce += income;
                gameState.totalCEEarned += income;
                
                // 2. Automation Income (Auto-Clicker)
                const autoCpc = calculateAutoClickerCPC();
                const autoIncome = autoCpc * deltaTime;
                gameState.ce += autoIncome;
                gameState.totalCEEarned += autoIncome;

                // 3. Auto-Save Check
                if (now - lastSaveTime > AUTO_SAVE_INTERVAL) {
                    saveGameState();
                }
                
                // 4. Auto-Upgrader Check
                if (gameState.autoUpgraderLevel > 0 && now > nextAutoUpgradeTime) {
                    autoUpgrade();
                    nextAutoUpgradeTime = now + AUTO_UPGRADER_INTERVAL;
                }
                
                // 5. Cosmic Event Check
                if (now > gameState.nextEventTime || (gameState.currentEvent && gameState.currentEvent.endTime <= now)) {
                     checkCosmicEvent();
                }
                
                // 6. Leaderboard Refresh
                if (now > nextLeaderboardRefresh) {
                    fetchLeaderboard();
                    nextLeaderboardRefresh = now + LEADERBOARD_REFRESH_INTERVAL;
                }
                
                // 7. Mascot Tip (Every 60s)
                if (now - (gameState.lastTipTime || 0) > 60000) {
                    generateMascotTip();
                    gameState.lastTipTime = now;
                }

                checkAchievements();
                updateUI();
            }

            requestAnimationFrame(gameLoop);
        }

        // --- INITIALIZATION ---
        async function initApp() {
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                // Authentication setup
                await new Promise((resolve) => {
                    onAuthStateChanged(auth, async (user) => {
                        if (user) {
                            userId = user.uid;
                        } else {
                            if (initialAuthToken) {
                                await signInWithCustomToken(auth, initialAuthToken);
                                userId = auth.currentUser.uid;
                            } else {
                                await signInAnonymously(auth);
                                userId = auth.currentUser.uid;
                            }
                        }
                        isAuthReady = true;
                        resolve();
                    });
                });

                loadGameState(userId);
                fetchLeaderboard(); // Initial leaderboard fetch
                gameLoop(); 
                
                $('player-id').textContent = userId;
                $('mute-btn').textContent = gameState.isMuted ? 'ðŸ”Š Unmute' : 'ðŸ”‡ Mute';


                // Attach Event Listeners
                $('source-circle').addEventListener('click', clickCE);
                $('manual-save-btn').addEventListener('click', () => saveGameState(true));
                $('reset-game-btn').addEventListener('click', resetGame);
                $('mute-btn').addEventListener('click', toggleMute);

                // Tab Listeners
                ['shop', 'automation', 'pets', 'prestige', 'achievements', 'leaderboard', 'stats'].forEach(tabName => {
                     $(`tab-${tabName}`).addEventListener('click', () => switchTab(tabName));
                });
                
                // Modal Listeners
                $('offline-collect-btn').addEventListener('click', dismissOfflineModal);
                $('reward-collect-btn').addEventListener('click', dismissDailyRewardModal);
                $('reset-confirm-btn').addEventListener('click', confirmReset);
                $('reset-cancel-btn').addEventListener('click', dismissResetModal);

                // Prestige Listeners
                $('prestige-1-btn').addEventListener('click', prestigeTier1);
                $('prestige-2-btn').addEventListener('click', prestigeTier2);
                $('prestige-3-btn').addEventListener('click', prestigeTier3);
                
                // Pet Listener
                $('pet-evolve-btn').addEventListener('click', evolvePet);
                
                // Initial Mascot tip
                generateMascotTip();

            } catch (error) {
                console.error("Firebase/App Initialization Error:", error);
            }
        }
        
        function switchTab(tabName) {
            gameState.currentTab = tabName;
            updateUI();
        }
        
        // Haptic Feedback (Android WebView) - No native browser support in iframe
        function triggerHaptic() {
            if ("vibrate" in navigator) {
                navigator.vibrate(50); // Light haptic feedback (50ms)
            }
        }


        window.onload = () => {
            initApp();
            // PWA Service Worker Registration
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('service-worker.js')
                    .then((reg) => console.log('Service Worker Registered'))
                    .catch((err) => console.log('Service Worker Registration Failed:', err));
            }
        };

    </script>


    <div class="game-container flex flex-col space-y-6">
        <h1 class="text-5xl font-extrabold text-center ce-color mt-4 mb-2" style="text-shadow: 0 0 10px rgba(255, 111, 145, 0.7);">COSMIC IDLE UNIVERSE</h1>
        <div class="text-center text-sm mb-4 text-gray-500 flex justify-center items-center space-x-4">
            <span id="player-id-display">ID: <span id="player-id">Loading...</span></span>
            <button id="mute-btn" class="accent-button text-xs px-3 py-1"></button>
            <span class="text-xs text-green-400">Cloud Save: Active</span>
        </div>

        <!-- Cosmic Event Timer -->
        <div id="event-container" class="dark-card p-3 text-center bg-yellow-900/40 border border-yellow-400/50 hidden">
            <p id="event-desc" class="text-xl font-bold text-yellow-300">A Cosmic Event is Active!</p>
            <p class="text-sm text-gray-300">Time Remaining: <span id="event-timer" class="font-mono">00h 00m 00s</span></p>
        </div>


        <!-- Resource Header -->
        <div class="dark-card p-4 grid grid-cols-2 md:grid-cols-4 gap-4 text-center border border-indigo-500/50">
            <div>
                <h2 class="text-lg font-bold ce-color">Cosmic Energy</h2>
                <div class="text-3xl font-extrabold" id="ce-amount">0.00</div>
                <p class="text-sm text-gray-400">CPC: <span id="cpc-amount">1.00</span> | CPS: <span id="cps-amount">0.00</span></p>
            </div>
            <div>
                <h2 class="text-lg font-bold sd-color">Stardust (T1)</h2>
                <div class="text-3xl font-extrabold" id="stardust-amount">0</div>
                <p class="text-sm text-gray-400">+5% CE/SD</p>
            </div>
            <div>
                <h2 class="text-lg font-bold gs-color">Galaxy Shards (T2)</h2>
                <div class="text-3xl font-extrabold" id="shards-amount">0</div>
                <p class="text-sm text-gray-400">Boosts SD Gains</p>
            </div>
            <div>
                <h2 class="text-lg font-bold uf-color">Universal Fragments (T3)</h2>
                <div class="text-3xl font-extrabold" id="fragments-amount">0</div>
                <p class="text-sm text-gray-400">Total Game Multiplier</p>
            </div>
        </div>

        <!-- Main Content Grid -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">

            <!-- Clicker & Mascot Panel (1/3 width on desktop) -->
            <div class="dark-card col-span-1 flex flex-col items-center p-6 space-y-6">
                <h2 class="text-2xl font-bold gs-color">The Core & Mascot</h2>
                
                <!-- Mascot Image & AI Tip -->
                <div class="w-full max-w-xs text-center mascot-container p-4 bg-gray-800/30 rounded-xl">
                    <img src="https://placehold.co/150x150/4C51BF/E6E8EA?text=Stardew" alt="Mascot" class="rounded-full mx-auto shadow-2xl" id="mascot-img" style="box-shadow: 0 0 15px #4C51BF;">
                    <p class="text-sm mt-3 sd-color font-semibold">Stardew, The Core Guardian</p>
                    <div class="mt-4 text-center p-3 bg-gray-900/50 rounded-lg border border-indigo-400/50">
                        <p id="mascot-text" class="text-sm italic text-gray-300">Stardew is thinking...</p>
                        <svg id="mascot-loader" class="animate-spin h-5 w-5 mx-auto text-indigo-400 hidden mt-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                    </div>
                </div>

                <!-- Click Source -->
                <div id="source-circle" class="source-circle">
                    <span class="ce-symbol">âš›ï¸</span>
                </div>
                
                <!-- Utility Buttons -->
                <div class="w-full flex space-x-2">
                    <button id="manual-save-btn" class="flex-1 accent-button px-4 py-2 rounded-xl">Manual Cloud Save</button>
                    <button id="reset-game-btn" class="flex-1 bg-red-600 text-white font-bold px-4 py-2 rounded-xl hover:bg-red-700 transition">Reset Game</button>
                </div>
            </div>

            <!-- Tabs Panel (2/3 width on desktop) -->
            <div class="lg:col-span-2 flex flex-col">
                <!-- Tab Buttons -->
                <div class="flex flex-wrap md:flex-nowrap justify-between">
                    <button id="tab-shop" class="tab-button active">ðŸ›’ Shop</button>
                    <button id="tab-automation" class="tab-button">ðŸ¤– Automation</button>
                    <button id="tab-pets" class="tab-button">â­ Pets</button>
                    <button id="tab-prestige" class="tab-button">âœ¨ Prestige</button>
                    <button id="tab-achievements" class="tab-button">ðŸ† Achievements</button>
                    <button id="tab-leaderboard" class="tab-button">ðŸ… Leaderboard</button>
                    <button id="tab-stats" class="tab-button">ðŸ“Š Stats</button>
                </div>

                <!-- Tab Content Container -->
                <div class="dark-card p-6 flex-grow rounded-t-none">
                    
                    <!-- 1. Shop Panel -->
                    <div id="panel-shop">
                        <h3 class="text-3xl font-bold mb-4 ce-color">Upgrades Shop</h3>
                        <p class="text-sm text-gray-400 mb-6">Purchase upgrades to boost your Cosmic Energy generation.</p>
                        
                        <!-- Click Upgrades -->
                        <div class="mb-8">
                            <h4 class="text-2xl font-semibold mb-3 gs-color">Click Power (CPC)</h4>
                            <div class="space-y-3">
                                <div id="cpc-card" class="upgrade-card flex flex-col sm:flex-row justify-between items-center p-4 rounded-xl">
                                    <div class="w-full sm:w-2/3">
                                        <h5 id="cpc-title" class="text-lg font-semibold text-white">Focus Lens (Lvl 0)</h5>
                                        <p id="cpc-desc" class="text-sm text-gray-400">Increases click power by +1 CE.</p>
                                    </div>
                                    <div class="flex items-center space-x-2 w-full sm:w-1/3 justify-end mt-2 sm:mt-0">
                                        <span id="cpc-cost" class="font-bold text-xl text-yellow-400">10</span>
                                        <span class="font-bold text-lg text-gray-300">CE</span>
                                        <button id="Buy-1" class="px-5 py-3 text-lg accent-button rounded-xl min-w-[100px]">Buy</button>
                                    </div>
                                </div>
                                <div id="cpcType2-card" class="upgrade-card flex flex-col sm:flex-row justify-between items-center p-4 rounded-xl">
                                    <div class="w-full sm:w-2/3">
                                        <h5 id="cpcType2-title" class="text-lg font-semibold text-white">Quantum Tap (Lvl 0)</h5>
                                        <p id="cpcType2-desc" class="text-sm text-gray-400">Increases click power by +10 CE.</p>
                                    </div>
                                    <div class="flex items-center space-x-2 w-full sm:w-1/3 justify-end mt-2 sm:mt-0">
                                        <span id="cpcType2-cost" class="font-bold text-xl text-yellow-400">10</span>
                                        <span class="font-bold text-lg text-gray-300">CE</span>
                                        <button id="Buy-2" class="px-5 py-3 text-lg accent-button rounded-xl min-w-[100px]">Buy</button>
                                    </div>
                                </div>
                                <div id="cpcType3-card" class="upgrade-card flex flex-col sm:flex-row justify-between items-center p-4 rounded-xl">
                                    <div class="w-full sm:w-2/3">
                                        <h5 id="cpcType3-title" class="text-lg font-semibold text-white">Singularity Click (Lvl 0)</h5>
                                        <p id="cpcType3-desc" class="text-sm text-gray-400">Increases click power by +100 CE.</p>
                                    </div>
                                    <div class="flex items-center space-x-2 w-full sm:w-1/3 justify-end mt-2 sm:mt-0">
                                        <span id="cpcType3-cost" class="font-bold text-xl text-yellow-400">10</span>
                                        <span class="font-bold text-lg text-gray-300">CE</span>
                                        <button id="Buy-3" class="px-5 py-3 text-lg accent-button rounded-xl min-w-[100px]">Buy</button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Passive Income Upgrades -->
                        <div>
                            <h4 class="text-2xl font-semibold mb-3 gs-color">Passive Income (CPS)</h4>
                            <div class="space-y-3">
                                <div id="cps-card" class="upgrade-card flex flex-col sm:flex-row justify-between items-center p-4 rounded-xl">
                                    <div class="w-full sm:w-2/3">
                                        <h5 id="cps-title" class="text-lg font-semibold text-white">Solar Panel (Lvl 0)</h5>
                                        <p id="cps-desc" class="text-sm text-gray-400">Increases passive income by +1 CPS.</p>
                                    </div>
                                    <div class="flex items-center space-x-2 w-full sm:w-1/3 justify-end mt-2 sm:mt-0">
                                        <span id="cps-cost" class="font-bold text-xl text-yellow-400">10</span>
                                        <span class="font-bold text-lg text-gray-300">CE</span>
                                        <button id="Buy-4" class="px-5 py-3 text-lg accent-button rounded-xl min-w-[100px]">Buy</button>
                                    </div>
                                </div>
                                <div id="cpsType2-card" class="upgrade-card flex flex-col sm:flex-row justify-between items-center p-4 rounded-xl">
                                    <div class="w-full sm:w-2/3">
                                        <h5 id="cpsType2-title" class="text-lg font-semibold text-white">Asteroid Miner (Lvl 0)</h5>
                                        <p id="cpsType2-desc" class="text-sm text-gray-400">Increases passive income by +10 CPS.</p>
                                    </div>
                                    <div class="flex items-center space-x-2 w-full sm:w-1/3 justify-end mt-2 sm:mt-0">
                                        <span id="cpsType2-cost" class="font-bold text-xl text-yellow-400">10</span>
                                        <span class="font-bold text-lg text-gray-300">CE</span>
                                        <button id="Buy-5" class="px-5 py-3 text-lg accent-button rounded-xl min-w-[100px]">Buy</button>
                                    </div>
                                </div>
                                <div id="cpsType3-card" class="upgrade-card flex flex-col sm:flex-row justify-between items-center p-4 rounded-xl">
                                    <div class="w-full sm:w-2/3">
                                        <h5 id="cpsType3-title" class="text-lg font-semibold text-white">Dyson Sphere (Lvl 0)</h5>
                                        <p id="cpsType3-desc" class="text-sm text-gray-400">Increases passive income by +100 CPS.</p>
                                    </div>
                                    <div class="flex items-center space-x-2 w-full sm:w-1/3 justify-end mt-2 sm:mt-0">
                                        <span id="cpsType3-cost" class="font-bold text-xl text-yellow-400">10</span>
                                        <span class="font-bold text-lg text-gray-300">CE</span>
                                        <button id="Buy-6" class="px-5 py-3 text-lg accent-button rounded-xl min-w-[100px]">Buy</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 2. Automation Panel -->
                    <div id="panel-automation" class="hidden">
                        <h3 class="text-3xl font-bold mb-4 sd-color">Automation Bots</h3>
                        <p class="text-sm text-gray-400 mb-6">Invest in bots to automate clicking and purchasing upgrades.</p>

                        <div class="space-y-3">
                            <div id="autoClicker-card" class="upgrade-card flex flex-col sm:flex-row justify-between items-center p-4 rounded-xl">
                                <div class="w-full sm:w-2/3">
                                    <h5 id="autoClicker-title" class="text-lg font-semibold text-white">Auto-Tapper Bot (Lvl 0)</h5>
                                    <p id="autoClicker-desc" class="text-sm text-gray-400">Taps automatically, adding <span id="auto-cpc-display">0.00</span> CE/s.</p>
                                </div>
                                <div class="flex items-center space-x-2 w-full sm:w-1/3 justify-end mt-2 sm:mt-0">
                                    <span id="autoClicker-cost" class="font-bold text-xl text-yellow-400">1K</span>
                                    <span class="font-bold text-lg text-gray-300">CE</span>
                                    <button id="Buy-Auto-1" class="px-5 py-3 text-lg accent-button rounded-xl min-w-[100px]">Upgrade</button>
                                </div>
                            </div>
                             <div id="autoUpgrader-card" class="upgrade-card flex flex-col sm:flex-row justify-between items-center p-4 rounded-xl">
                                <div class="w-full sm:w-2/3">
                                    <h5 id="autoUpgrader-title" class="text-lg font-semibold text-white">Auto-Shop Bot (Lvl 0)</h5>
                                    <p id="autoUpgrader-desc" class="text-sm text-gray-400">Automatically buys the cheapest available upgrade every 10s.</p>
                                </div>
                                <div class="flex items-center space-x-2 w-full sm:w-1/3 justify-end mt-2 sm:mt-0">
                                    <span id="autoUpgrader-cost" class="font-bold text-xl text-yellow-400">10K</span>
                                    <span class="font-bold text-lg text-gray-300">CE</span>
                                    <button id="Buy-Auto-2" class="px-5 py-3 text-lg accent-button rounded-xl min-w-[100px]">Upgrade</button>
                                </div>
                            </div>
                        </div>

                        <div class="mt-8 p-4 bg-gray-800 rounded-xl">
                            <h4 class="text-xl font-semibold gs-color">Automation Panel Status</h4>
                            <p class="text-gray-400 mt-2">Auto-Upgrader: <span id="auto-upgrader-status" class="font-bold">Inactive</span></p>
                            <p class="text-gray-400">Auto-Tapper Contribution: <span class="font-bold text-green-400" id="auto-cpc-display-2">0.00</span> CE/s</p>
                        </div>
                    </div>
                    
                    <!-- 3. Pets Panel -->
                    <div id="panel-pets" class="hidden">
                        <h3 class="text-3xl font-bold mb-4 gs-color">Pet Evolution</h3>
                        <p class="text-sm text-gray-400 mb-6">Your pet gains XP when you click. Leveling up grants a permanent CE multiplier.</p>
                        
                        <div class="dark-card p-6 flex flex-col md:flex-row items-center space-y-4 md:space-y-0 md:space-x-8 border-2 border-yellow-400/50">
                            <img id="pet-image" src="https://placehold.co/150x150/1A202C/FFC478?text=Spark" alt="Pet Mascot" class="rounded-full shadow-xl">
                            
                            <div class="flex-grow space-y-3">
                                <h4 class="text-3xl font-bold uf-color" id="pet-name">Cosmic Spark</h4>
                                <p class="text-lg font-semibold">Level: <span id="pet-level">1</span> | Evolution: <span id="pet-evolution">0</span></p>
                                <p class="text-lg font-semibold text-green-400">Current Bonus: <span id="pet-bonus">1%</span> CE Multiplier</p>

                                <div class="w-full bg-gray-600 rounded-full h-2.5">
                                    <div id="pet-xp-bar" class="bg-purple-600 h-2.5 rounded-full transition-all duration-300" style="width: 10%;"></div>
                                </div>
                                <p class="text-sm text-gray-400">XP: <span id="pet-xp">0</span> / <span id="pet-xp-needed">100</span> (1 XP per tap)</p>

                                <button id="pet-evolve-btn" class="accent-button bg-pink-600 hover:bg-pink-700 disabled:opacity-50 px-6 py-2">Evolve Pet</button>
                                <p id="pet-evolve-desc" class="text-xs italic text-gray-500 mt-1">Needs Level 10 for Evolution 2.</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 4. Prestige Panel -->
                    <div id="panel-prestige" class="hidden">
                        <h3 class="text-3xl font-bold mb-6 sd-color">Multi-Tier Prestige Systems</h3>
                        <p class="text-sm text-gray-400 mb-6">Rebirth the universe to gain permanent, compounding bonuses.</p>

                        <div class="space-y-8">
                            <!-- Tier 1: Stardust -->
                            <div class="dark-card p-6 border-2 border-purple-500">
                                <h4 class="text-2xl font-bold sd-color mb-3">Tier 1: Stardust Rebirth</h4>
                                <div class="flex flex-col md:flex-row justify-between items-center space-y-4 md:space-y-0">
                                    <div class="text-center md:text-left">
                                        <p class="text-lg font-semibold">Requirement: <span id="prestige-1-req-color" class="text-red-400"><span id="prestige-1-req">1,000,000</span> CE</span></p>
                                        <p class="text-xl font-bold mt-2">Will Gain: <span id="prestige-1-sd" class="sd-color text-3xl">0</span> SD</p>
                                        <p class="text-sm text-gray-500">Total Multiplier: <span id="prestige-1-multiplier">x1.00</span></p>
                                    </div>
                                    <button id="prestige-1-btn" class="px-8 py-3 text-xl accent-button rounded-xl bg-purple-600 hover:bg-purple-700 disabled:opacity-50">Initiate Stardust Rebirth</button>
                                </div>
                            </div>

                            <!-- Tier 2: Galaxy Shards -->
                            <div class="dark-card p-6 border-2 border-cyan-400">
                                <h4 class="text-2xl font-bold gs-color mb-3">Tier 2: Galactic Prestige</h4>
                                <div class="flex flex-col md:flex-row justify-between items-center space-y-4 md:space-y-0">
                                    <div class="text-center md:text-left">
                                        <p class="text-lg font-semibold">Requirement: <span id="prestige-2-req-color" class="text-red-400"><span id="prestige-2-req">10</span> SD</span></p>
                                        <p class="text-xl font-bold mt-2">Will Gain: <span id="prestige-2-gs" class="gs-color text-3xl">0</span> GS</p>
                                        <p class="text-sm text-gray-500">GS grants +10% SD/CE multiplier.</p>
                                    </div>
                                    <button id="prestige-2-btn" class="px-8 py-3 text-xl accent-button rounded-xl bg-cyan-600 hover:bg-cyan-700 disabled:opacity-50">Activate Galactic Shift</button>
                                </div>
                            </div>
                            
                             <!-- Tier 3: Universal Fragments -->
                            <div class="dark-card p-6 border-2 border-orange-400">
                                <h4 class="text-2xl font-bold uf-color mb-3">Tier 3: Universal Prestige</h4>
                                <div class="flex flex-col md:flex-row justify-between items-center space-y-4 md:space-y-0">
                                    <div class="text-center md:text-left">
                                        <p class="text-lg font-semibold">Requirement: <span id="prestige-3-req-color" class="text-red-400"><span id="prestige-3-req">5</span> GS</span></p>
                                        <p class="text-xl font-bold mt-2">Will Gain: <span id="prestige-3-uf" class="uf-color text-3xl">0</span> UF</p>
                                        <p class="text-sm text-gray-500">UF grants +20% ALL earnings multiplier.</p>
                                    </div>
                                    <button id="prestige-3-btn" class="px-8 py-3 text-xl accent-button rounded-xl bg-orange-600 hover:bg-orange-700 disabled:opacity-50">Commit Universal Reset</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 5. Achievements Panel -->
                    <div id="panel-achievements" class="hidden">
                        <h3 class="text-3xl font-bold mb-6 text-green-400">Achievement Records</h3>
                        <p class="text-sm text-gray-400 mb-6">Milestones and feats achieved across the cosmos.</p>
                        
                        <div id="achievements-list" class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <!-- Achievements rendered here -->
                        </div>
                    </div>
                    
                    <!-- 6. Leaderboard Panel -->
                    <div id="panel-leaderboard" class="hidden">
                        <h3 class="text-3xl font-bold mb-6 text-yellow-400">Global Leaderboard</h3>
                        <p class="text-sm text-gray-400 mb-6">Top players ranked by Stardust and Cosmic Energy.</p>
                        
                        <div class="space-y-2" id="leaderboard-list">
                            <!-- Leaderboard data rendered here -->
                        </div>
                    </div>
                    
                    <!-- 7. Stats Panel -->
                    <div id="panel-stats" class="hidden">
                        <h3 class="text-3xl font-bold mb-6 text-yellow-400">Player Statistics Panel</h3>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="dark-card p-4">
                                <h4 class="text-xl font-semibold sd-color">Prestige Runs</h4>
                                <p id="stat-prestige-runs" class="text-4xl font-extrabold mt-2">0</p>
                            </div>
                            <div class="dark-card p-4">
                                <h4 class="text-xl font-semibold gs-color">Galactic Shifts</h4>
                                <p id="stat-galaxy-runs" class="text-4xl font-extrabold mt-2">0</p>
                            </div>
                            <div class="dark-card p-4">
                                <h4 class="text-xl font-semibold ce-color">Lifetime Taps</h4>
                                <p id="stat-lifetime-taps" class="text-4xl font-extrabold mt-2">0</p>
                            </div>
                            <div class="dark-card p-4">
                                <h4 class="text-xl font-semibold uf-color">Total CE Earned</h4>
                                <p id="stat-total-ce" class="text-4xl font-extrabold mt-2">0</p>
                            </div>
                             <div class="dark-card p-4">
                                <h4 class="text-xl font-semibold text-pink-400">Highest Daily Streak</h4>
                                <p id="stat-highest-streak" class="text-4xl font-extrabold mt-2">0</p>
                            </div>
                            <div class="dark-card p-4">
                                <h4 class="text-xl font-semibold text-indigo-400">Active Events Triggered</h4>
                                <p id="stat-event-count" class="text-4xl font-extrabold mt-2">0</p>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </div>
        
        <!-- Offline Earnings Modal -->
        <div id="offline-modal" class="fixed inset-0 bg-black bg-opacity-75 hidden z-50 flex items-center justify-center">
            <div class="dark-card p-8 w-11/12 max-w-md text-center border-4 border-green-500">
                <h3 class="text-3xl font-bold mb-4 text-green-400">Offline Progress!</h3>
                <p class="text-lg mb-6 text-gray-300">
                    Your bots worked for <span id="offline-duration" class="font-extrabold text-yellow-400">0.0</span> hours!
                    You earned:
                </p>
                <p class="text-5xl font-extrabold mb-8 ce-color" id="offline-amount">0</p>
                <button id="offline-collect-btn" class="accent-button w-full py-3 text-xl rounded-xl bg-green-600 hover:bg-green-700 transition">Collect Cosmic Energy</button>
            </div>
        </div>
        
        <!-- Daily Reward Modal -->
        <div id="daily-reward-modal" class="fixed inset-0 bg-black bg-opacity-75 hidden z-50 flex items-center justify-center">
            <div class="dark-card p-8 w-11/12 max-w-md text-center border-4 border-yellow-500">
                <h3 class="text-3xl font-bold mb-4 text-yellow-400">Daily Login Bonus!</h3>
                <p class="text-lg mb-4 text-gray-300">
                    Streak: <span id="reward-streak" class="font-extrabold text-pink-400">1</span> day!
                </p>
                <p class="text-lg mb-6 text-gray-300">
                    You received:
                </p>
                <p class="text-5xl font-extrabold mb-8 ce-color" id="reward-amount">1,000</p>
                <button id="reward-collect-btn" class="accent-button w-full py-3 text-xl rounded-xl bg-yellow-600 hover:bg-yellow-700 transition">Awesome!</button>
            </div>
        </div>
        
        <!-- Reset Confirmation Modal -->
        <div id="reset-modal" class="fixed inset-0 bg-black bg-opacity-75 hidden z-50 flex items-center justify-center">
            <div class="dark-card p-8 w-11/12 max-w-sm text-center border-4 border-red-500">
                <h3 class="text-3xl font-bold mb-4 text-red-400">Confirm Game Wipe</h3>
                <p class="text-lg mb-6 text-gray-300">
                    Are you sure you want to completely wipe ALL progress? This action is permanent.
                </p>
                <div class="flex justify-between space-x-4">
                    <button id="reset-confirm-btn" class="flex-1 bg-red-600 text-white font-bold py-3 text-xl rounded-xl hover:bg-red-700 transition">Confirm Wipe</button>
                    <button id="reset-cancel-btn" class="flex-1 bg-gray-600 text-white font-bold py-3 text-xl rounded-xl hover:bg-gray-700 transition">Cancel</button>
                </div>
            </div>
        </div>
        
        <!-- Achievement Pop-up UI -->
        <div id="achievement-popup" class="achievement-popup hidden">
            <!-- Content set by JS -->
        </div>

    </div>
</body>
</html>
