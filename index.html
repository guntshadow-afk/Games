<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cosmic Universal Idle Game</title>
    <style>
        /* ======================================================= */
        /* CSS: DARK PASTEL ANIME THEME & RESPONSIVENESS (10, 12)  */
        /* ======================================================= */
        :root {
            --color-bg: #1a1a2e; /* Dark Blue/Purple */
            --color-primary: #ff41a1; /* Pink/Magenta */
            --color-secondary: #00f5d4; /* Neon Teal */
            --color-text: #e0e0f0;
            --color-accent: #8338ec; /* Violet */
            --font-main: 'Arial', sans-serif;
        }

        body {
            background-color: var(--color-bg);
            color: var(--color-text);
            font-family: var(--font-main);
            margin: 0;
            padding: 0;
            display: flex;
            min-height: 100vh;
            flex-direction: column;
            overflow-x: hidden;
            /* Animated background stars (10) */
            background-image: radial-gradient(white, rgba(255, 255, 255, 0.2) 2px, transparent 40px),
                              radial-gradient(white, rgba(255, 255, 255, 0.15) 1px, transparent 30px);
            background-size: 500px 500px, 300px 300px;
            animation: stars-move 120s linear infinite;
        }

        @keyframes stars-move {
            from { background-position: 0 0, 0 0; }
            to { background-position: 500px 500px, -300px -300px; }
        }

        /* UI/UX (8, 9) */
        .header {
            background-color: #2c2c54;
            padding: 10px 20px;
            text-align: center;
            border-bottom: 2px solid var(--color-primary);
        }

        .resource-display h1 {
            font-size: 3em; /* Large resource text (9) */
            color: var(--color-secondary);
            margin: 0;
            text-shadow: 0 0 10px var(--color-secondary);
        }

        .sidebar {
            width: 80px;
            background-color: #2c2c54;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding-top: 20px;
            border-right: 2px solid var(--color-accent);
        }

        .tab-button {
            background: none;
            border: none;
            color: var(--color-text);
            padding: 15px;
            margin-bottom: 10px;
            cursor: pointer;
            font-size: 1.5em;
            transition: color 0.2s, background-color 0.2s;
            border-radius: 5px;
        }

        .tab-button:hover, .tab-button.active {
            color: var(--color-primary);
            background-color: #3f3f77;
        }

        .game-container {
            display: flex;
            flex-grow: 1;
        }

        .content {
            flex-grow: 1;
            padding: 20px;
            display: none; /* All content hidden by default */
            flex-direction: column;
            align-items: center;
        }

        .content.active {
            display: flex;
        }

        /* Primary Action Button (1) */
        #primary-action-button {
            width: 250px;
            height: 250px;
            border-radius: 50%;
            background-color: var(--color-primary);
            color: var(--color-bg);
            font-size: 2em;
            border: 5px solid var(--color-secondary);
            cursor: pointer;
            transition: transform 0.1s;
            box-shadow: 0 0 20px var(--color-primary);
            margin-top: 50px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            user-select: none;
        }

        #primary-action-button:active {
            transform: scale(0.95); /* Click animation (1) */
        }

        /* Shop Styles */
        .upgrade-card {
            background-color: #2c2c54;
            border: 1px solid var(--color-accent);
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 400px;
        }

        .upgrade-card button {
            background-color: var(--color-secondary);
            color: var(--color-bg);
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.2s;
        }

        .upgrade-card button:hover:not(:disabled) {
            background-color: #00c7b2;
        }

        .upgrade-card button:disabled {
            background-color: #555; /* Auto-buy prevention (7) */
            cursor: not-allowed;
        }

        .floating-text {
            position: absolute;
            font-size: 1.5em;
            color: var(--color-primary);
            opacity: 0;
            user-select: none;
            pointer-events: none;
            animation: floatUp 1s ease-out forwards;
            text-shadow: 0 0 5px var(--color-primary);
        }

        @keyframes floatUp {
            from { transform: translateY(0); opacity: 1; }
            to { transform: translateY(-50px); opacity: 0; }
        }

        /* Status Bar */
        .status-bar {
            padding: 10px;
            background-color: #111;
            color: #999;
            font-size: 0.8em;
            text-align: right;
        }
    </style>
</head>
<body>

    <div class="header">
        <div class="resource-display">
            <h2>Cosmic Energy:</h2>
            <h1 id="energy-display">0</h1>
        </div>
        <p>
            <span style="color: var(--color-primary);">CPC: <span id="cpc-rate">1</span></span> | 
            <span style="color: var(--color-secondary);">CPS: <span id="cps-rate">0</span></span>
        </p>
    </div>

    <div class="game-container">
        <div class="sidebar">
            <button class="tab-button active" onclick="showTab('home', this)" title="Core">üè†</button>
            <button class="tab-button" onclick="showTab('shop', this)" title="Shop">üõí</button>
            <button class="tab-button" onclick="showTab('pets', this)" title="Pets">üëæ</button>
            <button class="tab-button" onclick="showTab('prestige', this)" title="Prestige">üå†</button>
            <button class="tab-button" onclick="showTab('stats', this)" title="Stats">üßÆ</button>
        </div>

        <div id="home" class="content active">
            <button id="primary-action-button" title="Generate Cosmic Energy">
                <span style="font-size: 0.5em; opacity: 0.8;">ATOM CORE</span>
                TAP TO GENERATE
            </button>
            <div id="mascot-display" style="margin-top: 30px; font-size: 2em; color: var(--color-accent);">
                ‚≠ê Mascot Helper ‚≠ê
            </div>
        </div>

        <div id="shop" class="content">
            <h2>üõí Shop & Upgrades</h2>
            <p style="color: var(--color-secondary);">Increase your Cosmic Energy production!</p>

            <h3 style="color: var(--color-primary);">CE Per Click (CPC) Upgrades (4)</h3>
            <div id="cpc-upgrades">
                </div>
            
            <h3 style="color: var(--color-secondary);">CE Per Second (CPS) Upgrades (5)</h3>
            <div id="cps-upgrades">
                </div>
        </div>

        <div id="pets" class="content">
            <h2>üëæ Mascot & Pet System (I)</h2>
            <p>Level your Mascot to unlock powerful passive skills.</p>
            <div id="mascot-info"></div>
        </div>

        <div id="prestige" class="content">
            <h2>üå† Prestige Systems (G)</h2>
            <p>Trade your Cosmic Energy for **Stardust** to gain permanent multipliers.</p>
            <p style="color: var(--color-primary);">Stardust Gained: <span id="stardust-potential">0</span></p>
            <button id="prestige-button" 
                    style="background-color: var(--color-primary); color: var(--color-bg); padding: 10px 20px; border: none; border-radius: 5px;"
                    onclick="startPrestige()">
                INITIATE PRESTIGE
            </button>
        </div>
        
        <div id="stats" class="content">
            <h2>üßÆ Statistics Panel (K)</h2>
            <div id="stats-panel"></div>
        </div>
    </div>
    
    <div class="status-bar">
        Cloud Status: <span id="cloud-status">Connecting...</span> (Q) | 
        Total Time Played: <span id="time-played">0s</span> (34)
    </div>

    <script>
        // ====================================================================
        // JAVASCRIPT: CORE GAME LOGIC
        // ====================================================================

        const UPGRADE_DATA = {
            cpc: {
                focusLens: { name: 'Focus Lens', baseValue: 1, baseCost: 10, multiplier: 1.15, description: '+1 CE per click' },
                quantumTap: { name: 'Quantum Tap', baseValue: 5, baseCost: 100, multiplier: 1.15, description: '+5 CE per click' },
            },
            cps: {
                solarPanel: { name: 'Solar Panel', baseValue: 0.1, baseCost: 20, multiplier: 1.15, description: '+0.1 CE per second' },
                asteroidMiner: { name: 'Asteroid Miner', baseValue: 1, baseCost: 200, multiplier: 1.15, description: '+1 CE per second' },
            },
        };

        const INITIAL_GAME_STATE = {
            // A. CORE RESOURCES & RATES
            resources: {
                cosmicEnergy: 0,
                stardust: 0, 
            },
            rates: {
                currentCEPerClick: 1,
                currentCEPerSecond: 0,
                globalMultiplier: 1.0, 
            },
            time: {
                lastSaveTime: Date.now(),
                totalTimePlayed: 0,
                lifetimeStats: { totalTaps: 0, totalCEEarned: 0, totalPrestiges: 0 },
            },
            // B. UPGRADES (Initialized with 0 level/default cost)
            upgrades: {
                cpc: {
                    focusLens: { level: 0, cost: 10 },
                    quantumTap: { level: 0, cost: 100 },
                },
                cps: {
                    solarPanel: { level: 0, cost: 20 },
                    asteroidMiner: { level: 0, cost: 200 },
                },
            },
            // G. PRESTIGE SYSTEM STATES
            prestige: {
                currentPrestigeCount: 0,
                stardustBonusMultiplier: 1.0, 
            },
            // I. MASCOT SYSTEM (Simplified)
            mascot: { level: 1, xp: 0 },
            // F. EVENTS (Simplified)
            events: { eventMultiplier: 1.0 },
            // T. EXTRA SYSTEMS (Simplified)
            extra: { luckyTapCritChance: 0.01 },
        };

        // Load or initialize GAME_STATE
        let GAME_STATE = JSON.parse(localStorage.getItem('cosmicIdleSave')) || INITIAL_GAME_STATE;
        // Merge in UPGRADE_DATA to fill out details/new upgrades after loading
        for (const type in UPGRADE_DATA) {
            for (const id in UPGRADE_DATA[type]) {
                if (!GAME_STATE.upgrades[type][id]) {
                    GAME_STATE.upgrades[type][id] = { level: 0, cost: UPGRADE_DATA[type][id].baseCost };
                }
            }
        }
        
        let lastUpdateTime = Date.now();
        let energyDisplayElement;
        let cpcRateElement;
        let cpsRateElement;
        const upgradeContainerCPC = document.getElementById('cpc-upgrades');
        const upgradeContainerCPS = document.getElementById('cps-upgrades');
        const clickButton = document.getElementById('primary-action-button');


        // ====================================================================
        // RATE CALCULATION & GAME LOGIC
        // ====================================================================

        /**
         * Calculates all CE per Click and CE per Second rates (A, G).
         */
        function calculateAllRates() {
            const state = GAME_STATE;
            
            // --- STEP 1: GLOBAL MULTIPLIERS ---
            let globalMult = 1.0;
            globalMult *= state.prestige.stardustBonusMultiplier; // (24) Stardust Bonus
            globalMult *= state.events.eventMultiplier; // (20) Event Boost
            state.rates.globalMultiplier = globalMult;

            // --- STEP 2: CALCULATE CPS ---
            let baseCPS = 0;
            for (const id in state.upgrades.cps) {
                const data = UPGRADE_DATA.cps[id];
                baseCPS += state.upgrades.cps[id].level * data.baseValue;
            }
            state.rates.currentCEPerSecond = baseCPS * globalMult;

            // --- STEP 3: CALCULATE CPC ---
            let baseCPC = 1; 
            for (const id in state.upgrades.cpc) {
                const data = UPGRADE_DATA.cpc[id];
                baseCPC += state.upgrades.cpc[id].level * data.baseValue;
            }
            state.rates.currentCEPerClick = baseCPC * globalMult;
        }

        /**
         * Handles manual click and grants CE (1).
         */
        function handlePrimaryAction(event) {
            const state = GAME_STATE;
            
            let gain = state.rates.currentCEPerClick;
            
            // (T-12) Crit Check
            let isCrit = Math.random() < state.extra.luckyTapCritChance;
            if (isCrit) {
                gain *= 10;
            }

            state.resources.cosmicEnergy += gain;
            
            // Update Stats (34)
            state.time.lifetimeStats.totalTaps += 1;
            state.time.lifetimeStats.totalCEEarned += gain;

            // (1) Floating Text Feedback
            showFloatingText(gain, event.clientX, event.clientY, isCrit);
            
            // (29) Mascot XP gain
            state.mascot.xp += 1; 

            updateDisplay();
        }

        /**
         * Purchases an upgrade (B, 6, 7).
         */
        function purchaseUpgrade(type, id) {
            const stateUpgrade = GAME_STATE.upgrades[type][id];
            const dataUpgrade = UPGRADE_DATA[type][id];
            
            // (6) Exponential Price Scaling: Cost = BaseCost * Multiplier^Level
            const cost = Math.ceil(dataUpgrade.baseCost * Math.pow(dataUpgrade.multiplier, stateUpgrade.level));

            if (GAME_STATE.resources.cosmicEnergy >= cost) {
                GAME_STATE.resources.cosmicEnergy -= cost;
                stateUpgrade.level += 1;
                
                calculateAllRates();
                updateDisplay();
            }
        }

        /**
         * The core game loop (2).
         */
        function gameLoop(currentTime) {
            const deltaTime = (currentTime - lastUpdateTime) / 1000;
            lastUpdateTime = currentTime;
            
            // Apply passive gains (2)
            const passiveGain = GAME_STATE.rates.currentCEPerSecond * deltaTime;
            GAME_STATE.resources.cosmicEnergy += passiveGain;
            
            // Update total time played (34)
            GAME_STATE.time.totalTimePlayed += deltaTime;

            // (54) Autosave every 5 seconds
            if (currentTime - GAME_STATE.time.lastSaveTime > 5000) {
                saveGame();
                GAME_STATE.time.lastSaveTime = currentTime;
            }
            
            // Update Display elements
            updateDisplay();
            requestAnimationFrame(gameLoop);
        }

        // ====================================================================
        // UTILITIES & DISPLAY (C)
        // ====================================================================

        /**
         * Formats large numbers compactly (9).
         */
        function formatNumber(num) {
            if (Math.abs(num) < 1000) return num.toFixed(num % 1 !== 0 ? 2 : 0);
            
            const suffixes = ["K", "M", "B", "T", "q", "Q", "S", "s", "O", "N", "D"];
            let i = 0;
            let absNum = Math.abs(num);
            while (absNum >= 1000 && i < suffixes.length) {
                absNum /= 1000;
                i++;
            }
            return absNum.toFixed(2) + suffixes[i - 1];
        }

        /**
         * Renders all dynamic UI elements (A, B, C).
         */
        function updateDisplay() {
            const state = GAME_STATE;
            const resources = state.resources;
            
            // Core Displays (A)
            energyDisplayElement.textContent = formatNumber(resources.cosmicEnergy);
            cpcRateElement.textContent = formatNumber(state.rates.currentCEPerClick);
            cpsRateElement.textContent = formatNumber(state.rates.currentCEPerSecond);
            document.getElementById('time-played').textContent = Math.round(state.time.totalTimePlayed) + 's';
            
            // Shop Updates (B)
            renderUpgrades('cpc', upgradeContainerCPC);
            renderUpgrades('cps', upgradeContainerCPS);
            
            // Prestige Updates (G)
            const stardustPotential = calculateStardustGain();
            document.getElementById('stardust-potential').textContent = formatNumber(stardustPotential);
            const prestigeBtn = document.getElementById('prestige-button');
            if (stardustPotential > 0) {
                prestigeBtn.disabled = false;
                prestigeBtn.style.opacity = 1;
            } else {
                prestigeBtn.disabled = true;
                prestigeBtn.style.opacity = 0.5;
            }
            
            // Stats Update (K)
            document.getElementById('stats-panel').innerHTML = `
                <p><strong>Total Taps:</strong> ${formatNumber(state.time.lifetimeStats.totalTaps)}</p>
                <p><strong>Total CE Earned:</strong> ${formatNumber(state.time.lifetimeStats.totalCEEarned)}</p>
                <p><strong>Total Prestiges:</strong> ${state.time.lifetimeStats.totalPrestiges}</p>
                <p><strong>Current Stardust:</strong> ${formatNumber(state.resources.stardust)}</p>
            `;

            // Mascot Update (I)
            document.getElementById('mascot-info').innerHTML = `
                <p>Level: <strong>${state.mascot.level}</strong></p>
                <p>XP: ${state.mascot.xp} / ${state.mascot.level * 100}</p>
            `;
        }
        
        /**
         * Dynamically generates and updates upgrade buttons (B, 6, 7).
         */
        function renderUpgrades(type, container) {
            container.innerHTML = '';
            for (const id in UPGRADE_DATA[type]) {
                const stateUpgrade = GAME_STATE.upgrades[type][id];
                const dataUpgrade = UPGRADE_DATA[type][id];
                const cost = Math.ceil(dataUpgrade.baseCost * Math.pow(dataUpgrade.multiplier, stateUpgrade.level));
                const canAfford = GAME_STATE.resources.cosmicEnergy >= cost;

                const card = document.createElement('div');
                card.className = 'upgrade-card';
                card.innerHTML = `
                    <div>
                        <strong>${dataUpgrade.name}</strong> (Lvl ${stateUpgrade.level})
                        <p style="font-size: 0.9em; margin: 2px 0;">${dataUpgrade.description}</p>
                    </div>
                    <div>
                        <button onclick="purchaseUpgrade('${type}', '${id}')" ${canAfford ? '' : 'disabled'}>
                            Buy (${formatNumber(cost)} CE)
                        </button>
                    </div>
                `;
                container.appendChild(card);
            }
        }
        
        /**
         * Creates the animated floating text feedback (1).
         */
        function showFloatingText(amount, x, y, isCrit) {
            const text = document.createElement('div');
            text.className = 'floating-text';
            text.textContent = `+${formatNumber(amount)}`;
            
            text.style.left = `${x}px`;
            text.style.top = `${y}px`;
            
            if (isCrit) {
                text.style.fontSize = '2em';
                text.style.color = var(--color-secondary);
            }

            document.body.appendChild(text);

            // Clean up the element after the animation
            text.addEventListener('animationend', () => {
                text.remove();
            });
        }
        
        /**
         * Calculates stardust for the prestige system (23).
         */
        function calculateStardustGain() {
            // Rule: 1 Stardust per 1,000,000 CE earned this run
            const gain = Math.floor(GAME_STATE.resources.cosmicEnergy / 1000000);
            return Math.max(0, gain);
        }

        /**
         * Handles the prestige reset logic (23).
         */
        function startPrestige() {
            const gain = calculateStardustGain();
            if (gain === 0) return;

            // 1. Grant Stardust
            GAME_STATE.resources.stardust += gain;

            // 2. Calculate new multiplier (24)
            // Example: +5% multiplier per 100 Stardust
            GAME_STATE.prestige.stardustBonusMultiplier = 1 + (GAME_STATE.resources.stardust / 100) * 0.05;

            // 3. Reset Resources and Upgrades
            GAME_STATE.resources.cosmicEnergy = 0;
            
            for (const type in GAME_STATE.upgrades) {
                for (const id in GAME_STATE.upgrades[type]) {
                    GAME_STATE.upgrades[type][id] = { level: 0, cost: UPGRADE_DATA[type][id].baseCost };
                }
            }

            // 4. Update Stats and Count
            GAME_STATE.prestige.currentPrestigeCount += 1;
            GAME_STATE.time.lifetimeStats.totalPrestiges += 1;

            alert(`PRESTIGE COMPLETE! Gained ${formatNumber(gain)} Stardust!`);
            
            calculateAllRates();
            saveGame();
            updateDisplay();
        }

        // ====================================================================
        // INITIALIZATION & SAVE/LOAD (Q)
        // ====================================================================

        /**
         * Saves game state to browser storage (54).
         */
        function saveGame() {
            localStorage.setItem('cosmicIdleSave', JSON.stringify(GAME_STATE));
            document.getElementById('cloud-status').textContent = 'Cloud Saved';
        }

        /**
         * Handles offline income calculation (2).
         */
        function calculateOfflineIncome() {
            const currentTime = Date.now();
            const timeOffline = (currentTime - GAME_STATE.time.lastSaveTime) / 1000;
            
            // Cap offline time at 24 hours (86400 seconds)
            const maxTime = 86400; 
            const effectiveTime = Math.min(timeOffline, maxTime);

            const gain = effectiveTime * GAME_STATE.rates.currentCEPerSecond * GAME_STATE.events.eventMultiplier; // (22) Offline Boosts
            if (gain > 0) {
                GAME_STATE.resources.cosmicEnergy += gain;
                alert(`Welcome back, Cosmic Explorer! Earned ${formatNumber(gain)} CE while you were away (${Math.round(effectiveTime)}s).`);
            }
        }

        /**
         * Initializes UI and starts game (C).
         */
        function initGame() {
            // Get initial UI references
            energyDisplayElement = document.getElementById('energy-display');
            cpcRateElement = document.getElementById('cpc-rate');
            cpsRateElement = document.getElementById('cps-rate');
            
            // 1. Initial Rate Calculation
            calculateAllRates();
            
            // 2. Offline Income Check
            calculateOfflineIncome();

            // 3. Setup Primary Click Handler (1)
            clickButton.addEventListener('click', handlePrimaryAction);
            
            // 4. Initial UI Render
            updateDisplay();
            
            // 5. Start the game loop
            lastUpdateTime = Date.now();
            requestAnimationFrame(gameLoop);
            
            // 6. Cloud Status (Q)
            document.getElementById('cloud-status').textContent = 'Connected & Syncing';
        }
        
        /**
         * Handles Tab Navigation (8).
         */
        function showTab(tabId, button) {
            document.querySelectorAll('.content').forEach(content => {
                content.classList.remove('active');
            });
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });

            document.getElementById(tabId).classList.add('active');
            button.classList.add('active');
        }

        // Wait for the HTML document to fully load before starting the game
        document.addEventListener('DOMContentLoaded', initGame);

        // Expose purchaseUpgrade to the global scope for use in the onclick attributes
        window.purchaseUpgrade = purchaseUpgrade;
        window.startPrestige = startPrestige;
        window.showTab = showTab;
        window.formatNumber = formatNumber; // Utility for debugging/display
    </script>
</body>
</html>
