<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Cosmic Universal Idle</title>
    
    <!-- PWA Settings -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#0f172a">
    <link rel="manifest" href="manifest.json">
    
    <!-- Fonts & Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;500;700;900&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.min.js"></script>

    <style>
        :root {
            --bg-deep: #050508;
            --primary: #6366f1;
            --accent: #22d3ee;
            --glass: rgba(30, 41, 59, 0.7);
            --glass-border: rgba(255, 255, 255, 0.08);
        }

        body {
            font-family: 'Outfit', sans-serif;
            background-color: var(--bg-deep);
            color: #e2e8f0;
            overflow: hidden; /* Prevent scrolling the whole page */
            height: 100vh;
            width: 100vw;
            display: flex;
            flex-direction: column;
        }

        /* Background Animation */
        .stars-bg {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1;
            background: 
                radial-gradient(1px 1px at 20% 30%, white, rgba(0,0,0,0)),
                radial-gradient(1px 1px at 40% 70%, white, rgba(0,0,0,0)),
                radial-gradient(1px 1px at 60% 40%, white, rgba(0,0,0,0)),
                radial-gradient(2px 2px at 80% 90%, white, rgba(0,0,0,0));
            background-repeat: repeat;
            background-size: 200px 200px;
            opacity: 0.3;
            animation: drift 100s linear infinite;
        }
        @keyframes drift { from { background-position: 0 0; } to { background-position: 1000px 1000px; } }

        /* UI Elements */
        .glass-panel {
            background: var(--bg-panel);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid var(--glass-border);
        }

        .card {
            @apply bg-slate-800/60 rounded-xl p-4 border border-white/5 shadow-lg backdrop-blur-md;
        }

        .btn-push {
            transition: transform 0.05s;
        }
        .btn-push:active:not(:disabled) {
            transform: scale(0.96);
        }

        /* Main Clicker */
        .core-btn {
            width: 220px; height: 220px;
            border-radius: 50%;
            background: radial-gradient(circle at 35% 35%, #ec4899, #6366f1);
            box-shadow: 0 0 60px rgba(99, 102, 241, 0.4), inset 0 0 20px rgba(255,255,255,0.3);
            display: flex; align-items: center; justify-content: center;
            font-size: 5rem; cursor: pointer; 
            position: relative; z-index: 10;
            transition: transform 0.1s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        .core-btn:active { transform: scale(0.9); }
        
        /* Floating Text */
        .float-txt {
            position: absolute; pointer-events: none; font-weight: 900; font-size: 1.5rem;
            animation: floatUp 0.8s ease-out forwards; z-index: 50; text-shadow: 0 2px 4px rgba(0,0,0,0.8);
            color: #fff;
        }
        @keyframes floatUp { 0% { transform: translateY(0) scale(0.5); opacity: 0; } 20% { opacity: 1; transform: translateY(-20px) scale(1.2); } 100% { transform: translateY(-100px) scale(1); opacity: 0; } }

        /* Bottom Nav Bar */
        .nav-bar {
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(10px);
            border-top: 1px solid rgba(255,255,255,0.1);
            padding-bottom: env(safe-area-inset-bottom);
        }
        .nav-item {
            @apply flex flex-col items-center justify-center p-2 text-gray-500 transition-colors duration-200 flex-1;
        }
        .nav-item.active {
            @apply text-indigo-400;
        }
        .nav-icon { font-size: 1.5rem; margin-bottom: 2px; }
        .nav-label { font-size: 0.65rem; font-weight: 700; letter-spacing: 0.05em; text-transform: uppercase; }

        /* Scrollbar Hide */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* Mini Game Target */
        .rhythm-target {
            position: absolute; width: 80px; height: 80px;
            background: radial-gradient(circle, #22d3ee, #0e7490);
            border-radius: 50%; border: 2px solid white;
            box-shadow: 0 0 20px #22d3ee;
            animation: pulse-target 1s infinite;
            cursor: pointer;
        }
        @keyframes pulse-target { 0% { transform: scale(0.9); } 50% { transform: scale(1.1); } 100% { transform: scale(0.9); } }
    </style>
</head>
<body>
    <div class="stars-bg"></div>

    <!-- TOP BAR: Resources -->
    <div class="flex-none p-3 bg-slate-900/80 backdrop-blur border-b border-white/10 z-20 flex justify-between items-center shadow-xl">
        <div>
            <p class="text-[10px] text-indigo-400 uppercase font-bold tracking-wider">Cosmic Energy</p>
            <p class="text-2xl font-black text-white font-mono leading-none" id="disp-ce">0</p>
        </div>
        <div class="text-right">
            <p class="text-[10px] text-emerald-400 uppercase font-bold tracking-wider">Rate</p>
            <p class="text-lg font-bold text-white font-mono leading-none"><span id="disp-cps">0</span>/s</p>
        </div>
    </div>

    <!-- MAIN CONTENT SCROLLABLE AREA -->
    <main class="flex-grow overflow-y-auto p-4 pb-24 no-scrollbar relative" id="main-view">
        
        <!-- TAB: HOME (Core) -->
        <div id="tab-home" class="tab-content flex flex-col items-center justify-center h-full min-h-[500px]">
            <div class="absolute top-0 w-full flex justify-center space-x-4 p-2 opacity-80">
                <div class="bg-purple-900/40 px-3 py-1 rounded border border-purple-500/30 text-xs">
                    <span class="text-purple-300 font-bold">SD:</span> <span id="disp-sd" class="text-white">0</span>
                </div>
                <div class="bg-teal-900/40 px-3 py-1 rounded border border-teal-500/30 text-xs">
                    <span class="text-teal-300 font-bold">GS:</span> <span id="disp-gs" class="text-white">0</span>
                </div>
            </div>

            <button id="core-btn" class="core-btn mb-8" onclick="clickCore(event)">
                <span class="text-6xl drop-shadow-lg">‚öõÔ∏è</span>
            </button>
            
            <div class="text-center space-y-1 animate-pulse">
                <p class="text-gray-400 text-xs uppercase tracking-widest">Tap to Generate</p>
                <p class="text-indigo-300 font-mono text-sm" id="disp-cpc">+1 per tap</p>
            </div>
        </div>

        <!-- TAB: UPGRADES -->
        <div id="tab-upgrades" class="tab-content hidden space-y-6 max-w-md mx-auto">
            <h2 class="text-2xl font-bold text-white mb-2">Upgrade Station</h2>
            
            <div>
                <h3 class="text-sm font-bold text-pink-400 uppercase tracking-widest mb-3 pl-1">Active Power</h3>
                <div id="list-click" class="space-y-3"></div>
            </div>

            <div>
                <h3 class="text-sm font-bold text-emerald-400 uppercase tracking-widest mb-3 pl-1">Automation</h3>
                <div id="list-idle" class="space-y-3"></div>
            </div>
        </div>

        <!-- TAB: MINI-GAME -->
        <div id="tab-minigame" class="tab-content hidden h-full relative">
             <div class="flex flex-col items-center justify-center h-full text-center">
                <div class="card p-8 max-w-sm w-full border border-cyan-500/30 bg-cyan-900/10">
                    <h2 class="text-3xl font-black text-cyan-400 mb-2">COSMIC RHYTHM</h2>
                    <p class="text-gray-400 text-sm mb-6">Tap targets to overload the core! Earn massive CE bonuses based on your production.</p>
                    <button class="btn-push w-full py-4 bg-cyan-600 hover:bg-cyan-500 text-white rounded-xl font-bold text-lg shadow-[0_0_20px_rgba(34,211,238,0.4)]" onclick="startRhythmGame()">
                        START SESSION
                    </button>
                </div>
             </div>
             <!-- Game Layer -->
             <div id="rhythm-layer" class="absolute inset-0 bg-black/90 z-50 hidden touch-none">
                 <button class="absolute top-4 right-4 text-white/50 font-bold p-2" onclick="endRhythmGame()">EXIT</button>
                 <div class="absolute top-4 left-4 text-cyan-400 font-mono text-xl">Score: <span id="rhythm-score">0</span></div>
                 <div id="rhythm-target-container"></div>
             </div>
        </div>

        <!-- TAB: PRESTIGE -->
        <div id="tab-prestige" class="tab-content hidden max-w-md mx-auto space-y-4">
            <div class="card border-l-4 border-purple-500">
                <div class="flex justify-between items-center">
                    <div>
                        <h3 class="text-xl font-bold text-white">Stardust Rebirth</h3>
                        <p class="text-xs text-gray-400">Reset for +5% Global Bonus</p>
                    </div>
                    <div class="text-right">
                        <p class="text-2xl font-black text-purple-400" id="val-sd-gain">+0</p>
                    </div>
                </div>
                <button class="btn-push w-full mt-4 bg-purple-600 text-white font-bold py-3 rounded-lg disabled:opacity-50 disabled:cursor-not-allowed" id="btn-prestige-1" onclick="doPrestige(1)">
                    REBIRTH (1M CE)
                </button>
            </div>

             <div class="card border-l-4 border-teal-500 opacity-90">
                <div class="flex justify-between items-center">
                    <div>
                        <h3 class="text-xl font-bold text-white">Galactic Shift</h3>
                        <p class="text-xs text-gray-400">Unlock Shards & Dimensions</p>
                    </div>
                    <div class="text-right">
                        <p class="text-2xl font-black text-teal-400" id="val-gs-gain">+0</p>
                    </div>
                </div>
                <button class="btn-push w-full mt-4 bg-teal-700 text-white font-bold py-3 rounded-lg disabled:opacity-50" id="btn-prestige-2" onclick="doPrestige(2)">
                    ASCEND (100 SD)
                </button>
            </div>
        </div>

        <!-- TAB: SETTINGS -->
        <div id="tab-settings" class="tab-content hidden max-w-md mx-auto space-y-6">
            <h2 class="text-2xl font-bold text-white mb-4">System Settings</h2>
            
            <div class="card space-y-4">
                <div>
                    <label class="text-xs text-gray-500 font-bold uppercase">Pilot Name</label>
                    <div class="flex gap-2 mt-1">
                        <input type="text" id="player-name-input" class="bg-black/30 border border-white/10 rounded px-3 py-2 text-white w-full focus:outline-none focus:border-indigo-500" placeholder="Enter Name">
                        <button class="bg-indigo-600 text-white px-4 rounded font-bold" onclick="setPlayerName()">SET</button>
                    </div>
                </div>
                <div>
                    <label class="text-xs text-gray-500 font-bold uppercase">User ID</label>
                    <p class="font-mono text-xs text-gray-300 bg-black/30 p-2 rounded mt-1 break-all select-all" id="user-id-display">Loading...</p>
                </div>
            </div>

            <div class="card">
                 <label class="text-xs text-gray-500 font-bold uppercase mb-2 block">App Management</label>
                 <!-- INSTALL BUTTON -->
                 <button id="install-app-btn" class="w-full bg-emerald-600 hover:bg-emerald-500 text-white font-bold py-3 rounded-lg mb-3 hidden">
                     üì≤ INSTALL APP
                 </button>
                 <button class="w-full bg-red-900/50 hover:bg-red-900 text-red-200 font-bold py-3 rounded-lg border border-red-800" onclick="resetGame()">
                     HARD RESET SAVE
                 </button>
            </div>
            
            <p class="text-center text-xs text-gray-600" id="save-status">Auto-save active.</p>
        </div>

    </main>

    <!-- BOTTOM NAVIGATION BAR -->
    <nav class="nav-bar flex justify-around items-center flex-none z-50">
        <button class="nav-item active" onclick="setTab('home')" id="nav-home">
            <span class="nav-icon">üåå</span>
            <span class="nav-label">Core</span>
        </button>
        <button class="nav-item" onclick="setTab('upgrades')" id="nav-upgrades">
            <span class="nav-icon">üõí</span>
            <span class="nav-label">Shop</span>
        </button>
        <button class="nav-item" onclick="setTab('minigame')" id="nav-minigame">
            <span class="nav-icon">üéÆ</span>
            <span class="nav-label">Game</span>
        </button>
        <button class="nav-item" onclick="setTab('prestige')" id="nav-prestige">
            <span class="nav-icon">‚ú®</span>
            <span class="nav-label">Prestige</span>
        </button>
        <button class="nav-item" onclick="setTab('settings')" id="nav-settings">
            <span class="nav-icon">‚öôÔ∏è</span>
            <span class="nav-label">Settings</span>
        </button>
    </nav>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'cosmic-app-edition';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        let db, auth, userId;

        // --- INSTALL PROMPT LOGIC ---
        let deferredPrompt;
        const installBtn = document.getElementById('install-app-btn');

        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            installBtn.classList.remove('hidden');
        });

        installBtn.addEventListener('click', async () => {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                if (outcome === 'accepted') {
                    installBtn.classList.add('hidden');
                }
                deferredPrompt = null;
            }
        });

        // --- GAME DATA ---
        const UPGRADES = {
            c1: { name: 'Focus Lens', base: 15, mult: 1.5, power: 1, type: 'click', desc: '+1 Base Click' },
            c2: { name: 'Quantum Tap', base: 250, mult: 1.6, power: 15, type: 'click', desc: '+15 Base Click' },
            c3: { name: 'Singularity', base: 5000, mult: 1.8, power: 150, type: 'click', desc: '+150 Base Click' },
            i1: { name: 'Solar Panel', base: 50, mult: 1.4, power: 1, type: 'idle', desc: '+1 CPS' },
            i2: { name: 'Auto-Miner', base: 500, mult: 1.5, power: 12, type: 'idle', desc: '+12 CPS' },
            i3: { name: 'Dyson Sphere', base: 10000, mult: 1.6, power: 200, type: 'idle', desc: '+200 CPS' }
        };

        let state = {
            ce: 0, sd: 0, gs: 0, uf: 0,
            upgrades: { c1: 0, c2: 0, c3: 0, i1: 0, i2: 0, i3: 0 },
            playerName: "Pilot",
            lastSave: Date.now()
        };

        // --- LOGIC ---
        function getCPC() {
            let base = 1;
            base += state.upgrades.c1 * UPGRADES.c1.power;
            base += state.upgrades.c2 * UPGRADES.c2.power;
            base += state.upgrades.c3 * UPGRADES.c3.power;
            const sdMult = 1 + (state.sd * 0.05);
            return base * sdMult;
        }

        function getCPS() {
            let base = 0;
            base += state.upgrades.i1 * UPGRADES.i1.power;
            base += state.upgrades.i2 * UPGRADES.i2.power;
            base += state.upgrades.i3 * UPGRADES.i3.power;
            const sdMult = 1 + (state.sd * 0.05);
            return base * sdMult;
        }

        // --- ACTIONS ---
        window.clickCore = (e) => {
            const gain = getCPC();
            state.ce += gain;
            createFloat(`+${format(gain)}`, e.clientX, e.clientY);
            updateUI();
        };

        window.buyUpgrade = (id) => {
            const u = UPGRADES[id];
            const cost = Math.floor(u.base * Math.pow(u.mult, state.upgrades[id]));
            if (state.ce >= cost) {
                state.ce -= cost;
                state.upgrades[id]++;
                updateUI();
            }
        };

        window.doPrestige = (tier) => {
            if (tier === 1 && state.ce >= 1000000) {
                state.sd += Math.floor(state.ce / 1000000);
                state.ce = 0;
                state.upgrades = { c1: 0, c2: 0, c3: 0, i1: 0, i2: 0, i3: 0 };
                updateUI();
                saveGame();
            }
        };
        
        window.setPlayerName = () => {
            const name = document.getElementById('player-name-input').value;
            if(name && name.length > 2) {
                state.playerName = name;
                saveGame();
                alert("Name Saved!");
            }
        };
        
        window.resetGame = () => {
            if(confirm("Hard Reset? This wipes cloud save.")) {
                state.ce = 0; state.sd = 0; state.gs = 0;
                state.upgrades = { c1:0,c2:0,c3:0,i1:0,i2:0,i3:0 };
                saveGame();
                updateUI();
            }
        };

        // --- MINI GAME ---
        let rhythmScore = 0;
        window.startRhythmGame = () => {
            document.getElementById('rhythm-layer').classList.remove('hidden');
            rhythmScore = 0;
            spawnTarget();
        };
        
        function spawnTarget() {
            const container = document.getElementById('rhythm-target-container');
            container.innerHTML = '';
            const t = document.createElement('div');
            t.className = 'rhythm-target';
            t.style.top = Math.random() * 60 + 20 + '%';
            t.style.left = Math.random() * 60 + 20 + '%';
            t.onclick = (e) => {
                e.stopPropagation();
                rhythmScore++;
                document.getElementById('rhythm-score').innerText = rhythmScore;
                // REWARD: Bonus equal to 100 clicks OR 60s of idle
                const bonus = Math.max(getCPC() * 100, getCPS() * 60);
                state.ce += bonus;
                createFloat(`+${format(bonus)}!`, e.clientX, e.clientY, '#22d3ee');
                
                if(rhythmScore >= 5) {
                    endRhythmGame();
                    createFloat("GAME COMPLETE!", window.innerWidth/2, window.innerHeight/2, '#4ade80');
                } else {
                    spawnTarget();
                }
            };
            container.appendChild(t);
        }
        
        window.endRhythmGame = () => {
             document.getElementById('rhythm-layer').classList.add('hidden');
        };

        // --- UI ---
        function updateUI() {
            document.getElementById('disp-ce').innerText = format(state.ce);
            document.getElementById('disp-sd').innerText = format(state.sd);
            document.getElementById('disp-gs').innerText = format(state.gs);
            document.getElementById('disp-cps').innerText = format(getCPS());
            document.getElementById('disp-cpc').innerText = `+${format(getCPC())}`;
            
            document.getElementById('val-sd-gain').innerText = `+${format(Math.floor(state.ce / 1000000))}`;
            
            // Settings
            document.getElementById('user-id-display').innerText = userId || 'Loading...';

            // Render Shop
            const cList = document.getElementById('list-click');
            const iList = document.getElementById('list-idle');
            cList.innerHTML = ''; iList.innerHTML = '';

            for (const [k, v] of Object.entries(UPGRADES)) {
                const lvl = state.upgrades[k];
                const cost = Math.floor(v.base * Math.pow(v.mult, lvl));
                const canAfford = state.ce >= cost;
                
                const html = `
                    <div class="card flex justify-between items-center mb-2">
                        <div>
                            <div class="font-bold text-sm text-gray-200">${v.name} <span class="text-xs text-indigo-400">Lvl ${lvl}</span></div>
                            <div class="text-[10px] text-gray-500">${v.desc}</div>
                        </div>
                        <button class="px-4 py-2 rounded-lg text-xs font-bold shadow-lg transition-transform active:scale-95 ${canAfford ? 'bg-indigo-600 text-white' : 'bg-slate-700 text-gray-500 opacity-50'}" 
                            onclick="window.buyUpgrade('${k}')">${format(cost)}</button>
                    </div>`;
                
                if (v.type === 'click') cList.innerHTML += html;
                else iList.innerHTML += html;
            }
            
            // Prestige Button state
            const btnP1 = document.getElementById('btn-prestige-1');
            if (state.ce < 1000000) { btnP1.disabled = true; btnP1.innerText = "Need 1M CE"; }
            else { btnP1.disabled = false; btnP1.innerText = "REBIRTH NOW"; }
        }

        function format(num) {
            if (num >= 1e9) return (num / 1e9).toFixed(2) + "B";
            if (num >= 1e6) return (num / 1e6).toFixed(2) + "M";
            if (num >= 1e3) return (num / 1e3).toFixed(2) + "K";
            return Math.floor(num).toLocaleString();
        }

        function createFloat(text, x, y, color='#fff') {
            const el = document.createElement('div');
            el.className = 'float-txt';
            el.innerText = text;
            el.style.left = x + 'px';
            el.style.top = y + 'px';
            el.style.color = color;
            document.body.appendChild(el);
            setTimeout(() => el.remove(), 800);
        }

        window.setTab = (id) => {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
            document.getElementById(`tab-${id}`).classList.remove('hidden');
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            document.getElementById(`nav-${id}`).classList.add('active');
        };

        // --- INIT ---
        async function init() {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            await signInAnonymously(auth);
            userId = auth.currentUser.uid;

            onSnapshot(doc(db, 'artifacts', appId, 'users', userId, 'save', 'main'), (snap) => {
                if (snap.exists()) {
                    const data = snap.data();
                    const now = Date.now();
                    const seconds = (now - data.lastSave) / 1000;
                    // Offline Calculation
                    if (seconds > 10) {
                        // Calculate what they earned based on loaded upgrades
                        let tempState = { ...state, ...data };
                        let baseCPS = 0;
                        baseCPS += tempState.upgrades.i1 * UPGRADES.i1.power;
                        baseCPS += tempState.upgrades.i2 * UPGRADES.i2.power;
                        baseCPS += tempState.upgrades.i3 * UPGRADES.i3.power;
                        const gain = baseCPS * (1 + tempState.sd * 0.05) * seconds;
                        if (gain > 0) {
                             state.ce += gain; // Add to current session immediately
                             alert(`Offline for ${Math.floor(seconds)}s. Earned ${format(gain)} CE.`);
                        }
                    }
                    state = { ...state, ...data };
                }
                updateUI();
            });

            setInterval(() => {
                state.ce += getCPS() / 10;
                updateUI();
            }, 100);

            setInterval(saveGame, 5000);

            window.setTab('home');
        }

        function saveGame() {
             if(!userId) return;
             state.lastSave = Date.now();
             setDoc(doc(db, 'artifacts', appId, 'users', userId, 'save', 'main'), state);
             document.getElementById('save-status').innerText = 'Saved.';
             setTimeout(() => document.getElementById('save-status').innerText = '', 1000);
        }

        window.onload = init;
    </script>
</body>
</html>
