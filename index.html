<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Cosmic Universal Idle</title>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="manifest" href="manifest.json">
    
    <!-- Fonts & Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;500;700;900&family=JetBrains+Mono:wght==400;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.min.js"></script>

    <style>
        :root {
            --bg-deep: #020204;
            --bg-panel: rgba(20, 25, 40, 0.95);
            --primary: #6366f1;
            --secondary: #ec4899;
            --accent: #22d3ee;
            --border: rgba(255, 255, 255, 0.1);
        }

        body {
            font-family: 'Outfit', sans-serif;
            background-color: var(--bg-deep);
            color: #e2e8f0;
            overflow: hidden;
            height: 100vh;
            width: 100vw;
            /* Hide content initially to prevent FOUC before loading screen takes over */
            opacity: 0;
            transition: opacity 0.5s;
        }
        
        body.loaded {
            opacity: 1;
        }

        /* --- UI COMPONENTS --- */
        .glass-panel {
            background: var(--bg-panel);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid var(--border);
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
        }

        .btn-push {
            transition: all 0.1s cubic-bezier(0.4, 0, 0.2, 1);
            border-bottom: 3px solid rgba(0,0,0,0.4);
            position: relative;
            overflow: hidden;
        }
        .btn-push:active:not(:disabled) {
            transform: translateY(2px);
            border-bottom-width: 0px;
            margin-top: 2px;
        }
        .btn-push:disabled { opacity: 0.5; filter: grayscale(100%); cursor: not-allowed; border-bottom-width: 0px;}

        /* Main Clicker */
        .core-btn {
            width: 220px; height: 220px;
            border-radius: 50%;
            background: radial-gradient(circle at 40% 40%, #6366f1, #1e1b4b);
            box-shadow: 0 0 50px rgba(99, 102, 241, 0.3), inset 0 0 20px rgba(255,255,255,0.1);
            display: flex; align-items: center; justify-content: center;
            font-size: 5rem; cursor: pointer; 
            position: relative; z-index: 10;
            transition: transform 0.05s;
            border: 4px solid rgba(99, 102, 241, 0.3);
        }
        .core-btn:active { transform: scale(0.92); }
        
        /* Floating Text */
        .float-txt {
            position: absolute; pointer-events: none; font-weight: 900; font-size: 1.2rem;
            animation: floatUp 1s ease-out forwards; z-index: 50; text-shadow: 0 2px 4px rgba(0,0,0,0.8);
            color: #fff;
        }
        @keyframes floatUp { 0% { transform: translateY(0) scale(1); opacity: 1; } 100% { transform: translateY(-80px) scale(1.5); opacity: 0; } }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* Nav */
        .nav-item { @apply flex items-center p-3 rounded-lg cursor-pointer transition-colors text-gray-400 hover:text-white hover:bg-white/5 border border-transparent; }
        .nav-item.active { @apply bg-indigo-900/40 text-indigo-300 border-indigo-500/50 shadow-[0_0_15px_rgba(99,102,241,0.15)]; }

        /* Highlight for Tutorial */
        .tutorial-highlight {
            position: relative;
            z-index: 100;
            box-shadow: 0 0 0 4px #fbbf24, 0 0 30px rgba(251, 191, 36, 0.8);
            border-color: #fbbf24 !important;
            animation: pulse-highlight 1s infinite;
            pointer-events: auto !important;
        }
        @keyframes pulse-highlight { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.02); } }
        
        /* Tutorial overlay background: Blur removed and opacity slightly reduced */
        .tutorial-overlay-bg {
            background-color: rgba(0,0,0,0.7); 
            backdrop-filter: blur(0px); /* REMOVED BLUR */
            -webkit-backdrop-filter: blur(0px); /* REMOVED BLUR */
            pointer-events: none; 
        }

        /* --- RESPONSIVE TUTORIAL MODAL FIXES --- */
        #tut-modal {
            position: absolute;
            /* Default: Centered on screen, high z-index */
            top: 50%; 
            left: 50%;
            transform: translate(-50%, -50%);
            width: 90%; /* Mobile width */
            max-width: 448px; /* max-w-md */
            transition: all 0.3s ease;
        }

        /* Mobile shift: Place lower for better visibility/reach on small screens */
        @media (max-width: 767px) {
            #tut-modal {
                top: auto; /* Ignore vertical center */
                bottom: 10%; /* Place 10% from the bottom */
                transform: translate(-50%, 0); /* Center horizontally only */
                max-width: 90%; 
                margin: 0;
            }
        }
        
        /* Desktop shift: Move it right on larger screens (md+) to avoid core button */
        @media (min-width: 768px) {
            #tut-modal {
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                margin-left: 200px; /* Offset on desktop */
                max-width: 448px; 
            }
        }
        /* --- END RESPONSIVE FIXES --- */

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        #icon-spinner {
            animation: spin 1s linear infinite;
        }
        
        /* --- LOADING SCREEN STYLES --- */
        #app-loading-screen {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: radial-gradient(circle at center, #0a0e1c 0%, #020204 100%);
            z-index: 1000;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: opacity 0.5s ease-out;
        }
        
        @keyframes pulse-ring {
            0% { transform: scale(0.3); opacity: 0.8; }
            50% { transform: scale(1); opacity: 0; }
            100% { transform: scale(1); opacity: 0; }
        }

        .cosmic-loader {
            position: relative;
            width: 150px;
            height: 150px;
            margin-bottom: 2rem;
        }

        .cosmic-loader .core-star {
            width: 50px;
            height: 50px;
            background: #ffcc00;
            border-radius: 50%;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            box-shadow: 0 0 30px #ffcc00, 0 0 50px #ff00ff;
            animation: spin 6s linear infinite reverse;
        }
        
        .cosmic-loader .pulse-wave {
            position: absolute;
            width: 100%;
            height: 100%;
            border: 4px solid rgba(99, 102, 241, 0.5); /* Primary color */
            border-radius: 50%;
            animation: pulse-ring 2s infinite ease-out;
        }

        .cosmic-loader .pulse-wave:nth-child(2) {
            animation-delay: 0.5s;
        }
        
        /* New styles for forms in Settings tab */
        .form-group { @apply mb-4; }
        .form-input { @apply w-full p-3 rounded-lg bg-white/5 border border-white/10 focus:border-indigo-400 text-white transition; }

    </style>
</head>
<!-- Initial opacity is 0 on body, will be set to 1 when loading screen is done -->
<body class="flex flex-col md:flex-row">
    
    <!-- Loading Screen (Z-index 1000) -->
    <div id="app-loading-screen">
        <div class="cosmic-loader">
            <div class="pulse-wave"></div>
            <div class="pulse-wave"></div>
            <div class="core-star"></div>
        </div>
        <p class="text-3xl font-bold text-indigo-400">COSMIC INIT...</p>
        <p class="text-sm text-gray-500 mt-2" id="loading-message">Preparing the Universal Interface</p>
    </div>

    <!-- TUTORIAL OVERLAY (Fixed: pointer-events-none) -->
    <div id="tutorial-overlay" class="fixed inset-0 z-[200] hidden tutorial-overlay-bg flex-col items-center justify-center">
        <!-- Tutorial Modal (Fixed: pointer-events-auto) -->
        <div id="tut-modal" class="glass-panel p-8 max-w-md text-center border-2 border-yellow-400 shadow-2xl pointer-events-auto">
            <div class="text-5xl mb-4">ü§ñ</div>
            <h3 class="text-2xl font-bold text-yellow-400 mb-2" id="tut-title">System Online</h3>
            <p class="text-gray-300 mb-6 leading-relaxed" id="tut-text">Initializing pilot interface...</p>
            <button id="tut-continue-btn" class="btn-push bg-green-600 hover:bg-green-500 text-white px-8 py-3 rounded-lg font-bold text-lg shadow-lg" onclick="nextTutorial(false)">CONTINUE</button>
            <p id="tut-action-text" class="text-sm mt-4 text-yellow-300 hidden">Please interact with the highlighted element in the game.</p>
        </div>
    </div>

    <!-- SIDEBAR (Desktop) / BOTTOM BAR (Mobile) -->
    <nav class="md:w-64 bg-[#080b14] border-r border-white/10 flex-shrink-0 flex flex-col z-50 md:relative fixed bottom-0 w-full md:h-full h-auto border-t md:border-t-0">
        
        <!-- App Icon and Title -->
        <div class="p-6 hidden md:block border-b border-white/5 text-center">
            <div id="app-icon-container" class="w-20 h-20 mx-auto mb-2 relative">
                <!-- Icon Spinner (Visible while loading) -->
                <div id="icon-spinner" class="absolute inset-0 flex items-center justify-center text-xs text-indigo-400 border-2 border-dashed border-indigo-400/50 rounded-xl">
                    <span class="animate-spin text-3xl">‚öõÔ∏è</span>
                </div>
                <!-- App Icon (Hidden until loaded) -->
                <img id="app-icon" src="" alt="App Icon" class="w-full h-full rounded-xl object-cover shadow-lg border-2 border-indigo-400/50 hidden">
            </div>
            <h1 class="text-xl font-black tracking-tight text-white">COSMIC<span class="text-indigo-500">IDLE</span></h1>
        </div>
        
        <!-- Nav Links -->
        <div class="flex md:flex-col overflow-x-auto md:overflow-visible p-2 md:p-4 gap-2 no-scrollbar" id="nav-container">
            <button id="nav-home" class="nav-item active" onclick="window.setTab('home')">
                <span class="text-xl mr-3">üåå</span> <span class="hidden md:inline font-bold">Core</span>
            </button>
            <button id="nav-upgrades" class="nav-item" onclick="window.setTab('upgrades')">
                <span class="text-xl mr-3">üõí</span> <span class="hidden md:inline font-bold">Shop</span>
            </button>
            <button id="nav-pets" class="nav-item" onclick="window.setTab('pets')">
                <span class="text-xl mr-3">üëæ</span> <span class="hidden md:inline font-bold">Pets</span>
            </button>
            <button id="nav-relics" class="nav-item" onclick="window.setTab('relics')">
                <span class="text-xl mr-3">üè∫</span> <span class="hidden md:inline font-bold">Relics</span>
            </button>
            <button id="nav-prestige" class="nav-item" onclick="window.setTab('prestige')">
                <span class="text-xl mr-3">‚ú®</span> <span class="hidden md:inline font-bold">Prestige</span>
            </button>
            <button id="nav-leaderboard" class="nav-item" onclick="window.setTab('leaderboard')">
                <span class="text-xl mr-3">üèÜ</span> <span class="hidden md:inline font-bold">Ranks</span>
            </button>
            <button id="nav-settings" class="nav-item" onclick="window.setTab('settings')">
                <span class="text-xl mr-3">‚öôÔ∏è</span> <span class="hidden md:inline font-bold">Settings</span>
            </button>
        </div>
    </nav>

    <!-- MAIN CONTENT AREA -->
    <main class="flex-grow relative h-full overflow-hidden flex flex-col">
        
        <!-- TOP BAR -->
        <div class="glass-panel m-2 md:m-4 p-4 flex flex-wrap justify-between items-center z-40 shrink-0">
            <div>
                <p class="text-[10px] text-indigo-400 uppercase tracking-widest font-bold">Cosmic Energy</p>
                <p class="text-3xl md:text-4xl font-black text-white font-mono tracking-tight" id="disp-ce">0</p>
            </div>
            <div class="text-right hidden sm:block">
                <p class="text-[10px] text-gray-500 uppercase">Income Rate</p>
                <p class="text-lg font-bold text-emerald-400 font-mono" id="disp-cps">0/s</p>
            </div>
            <div class="flex gap-4 text-center">
                <div class="bg-purple-900/30 px-3 py-1 rounded border border-purple-500/30">
                    <p class="text-[10px] text-purple-300 font-bold">STARDUST</p>
                    <p class="text-lg font-bold text-white" id="disp-sd">0</p>
                </div>
                <div class="bg-teal-900/30 px-3 py-1 rounded border border-teal-500/30">
                    <p class="text-[10px] text-teal-300 font-bold">SHARDS</p>
                    <p class="text-lg font-bold text-white" id="disp-gs">0</p>
                </div>
            </div>
        </div>

        <!-- SCROLLABLE CONTENT -->
        <div class="flex-grow overflow-y-auto p-4 pb-24 md:pb-4" id="main-scroll">
            
            <!-- TAB: HOME -->
            <div id="tab-home" class="tab-content h-full flex flex-col items-center justify-center min-h-[500px]">
                <button id="core-btn" class="core-btn mt-8 hover:scale-105 active:scale-95 transition-transform" onclick="clickCore(event)">
                    <span class="text-6xl drop-shadow-lg">‚öõÔ∏è</span>
                </button>
                <p class="mt-8 text-gray-400 text-sm animate-pulse">Tap to generate energy</p>
                <p class="mt-2 text-xs text-gray-600 font-mono" id="save-status">System Loading...</p>
            </div>

            <!-- TAB: SHOP -->
            <div id="tab-upgrades" class="tab-content hidden max-w-3xl mx-auto space-y-6">
                <div class="flex justify-between items-end border-b border-white/10 pb-4">
                    <h2 class="text-3xl font-bold text-white">Upgrades</h2>
                </div>
                
                <div class="glass-panel p-6">
                    <h3 class="text-sm font-bold text-pink-400 uppercase tracking-widest mb-4">Click Power</h3>
                    <div id="list-click" class="grid grid-cols-1 gap-3">
                        <!-- Generated on Load -->
                    </div>
                </div>

                <div class="glass-panel p-6">
                    <h3 class="text-sm font-bold text-emerald-400 uppercase tracking-widest mb-4">Passive Income</h3>
                    <div id="list-idle" class="grid grid-cols-1 gap-3">
                         <!-- Generated on Load -->
                    </div>
                </div>
            </div>

            <!-- TAB: PETS -->
            <div id="tab-pets" class="tab-content hidden max-w-5xl mx-auto space-y-6">
                <h2 class="text-3xl font-bold text-white mb-2">Companion Roster (Total: 54)</h2>
                <div id="pet-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
            </div>

            <!-- TAB: RELICS -->
            <div id="tab-relics" class="tab-content hidden max-w-5xl mx-auto">
                <h2 class="text-3xl font-bold text-amber-400 mb-2">Ancient Relics (Total: 53)</h2>
                <p class="text-sm text-gray-400 mb-6">Rare artifacts that provide powerful global bonuses. Find them by playing!</p>
                
                <div id="relic-grid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                    <!-- Relics generated here -->
                </div>
            </div>

            <!-- TAB: PRESTIGE -->
            <div id="tab-prestige" class="tab-content hidden max-w-3xl mx-auto space-y-6">
                <div class="glass-panel p-6 border-l-4 border-purple-500">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-2xl font-bold text-white">Stardust Rebirth (Tier I)</h3>
                        <div class="text-right">
                            <p class="text-3xl font-black text-purple-400" id="val-sd-gain">+0</p>
                            <p class="text-[10px] text-gray-500 uppercase">Potential Gain</p>
                        </div>
                    </div>
                    <p class="text-sm text-gray-400 mb-4">Reset CE & Upgrades. Gain +5% Global Multiplier per Stardust.</p>
                    <button class="btn-push w-full bg-purple-600 hover:bg-purple-500 text-white font-bold py-3 rounded-lg" onclick="doPrestige(1)">
                        REBIRTH (Req: 1M CE)
                    </button>
                </div>
                <!-- Tier 2 -->
                 <div class="glass-panel p-6 border-l-4 border-teal-500 opacity-90 hover:opacity-100 transition">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-bold text-white">Galactic Shift (Tier II)</h3>
                        <div class="text-right">
                            <p class="text-2xl font-black text-teal-400" id="val-gs-gain">+0</p>
                        </div>
                    </div>
                     <p class="text-sm text-gray-400 mb-4">Reset Stardust. Unlocks advanced automation.</p>
                    <button class="btn-push w-full mt-4 bg-teal-700 text-white font-bold py-3 rounded-lg disabled:opacity-50" id="btn-prestige-2" onclick="doPrestige(2)">
                        ASCEND (Req: 100 SD)
                    </button>
                </div>
            </div>
            
            <!-- TAB: LEADERBOARD -->
            <div id="tab-leaderboard" class="tab-content hidden max-w-3xl mx-auto">
                <h2 class="text-3xl font-bold text-yellow-400 mb-4">Galactic Rankings</h2>
                <div class="glass-panel p-4">
                     <p class="text-gray-400 text-sm mb-4 text-center italic">Leaderboard requires cloud sync. You are currently in Local Mode.</p>
                     <ul id="leaderboard-list" class="space-y-2 text-gray-300">
                         <li class="text-center">Simulating local rankings...</li>
                     </ul>
                </div>
            </div>

            <!-- TAB: SETTINGS (NEW) -->
            <div id="tab-settings" class="tab-content hidden max-w-xl mx-auto space-y-6">
                <h2 class="text-3xl font-bold text-white">Account & Sync</h2>
                
                <div id="account-status-panel" class="glass-panel p-6 border-l-4 border-yellow-500">
                    <p class="text-xl font-bold text-yellow-400">Loading Status...</p>
                    <p class="text-sm text-gray-300 mt-2">Connecting to the Firebase system.</p>
                </div>
                
                <div id="auth-form-panel" class="glass-panel p-6 space-y-4">
                    <h3 class="text-xl font-semibold text-white">Link Account / Sign In</h3>
                    <form id="email-auth-form" onsubmit="window.handleAuth(event)">
                        <div class="form-group">
                            <input id="email-input" type="email" placeholder="Email Address" class="form-input" required>
                        </div>
                        <div class="form-group">
                            <input id="password-input" type="password" placeholder="Password (min 6 chars)" class="form-input" required minlength="6">
                        </div>
                        <button id="auth-button" type="submit" class="btn-push w-full bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-3 rounded-lg shadow-lg">
                            Sign In / Link Account
                        </button>
                        <p class="text-xs text-gray-500 mt-2 text-center">Linking an account syncs your current progress to the cloud, allowing cross-device play.</p>
                    </form>
                </div>
            </div>
            <!-- END TAB: SETTINGS -->

        </div>
    </main>

    <script type="module">
        // --- FIREBASE IMPORTS ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, signInAnonymously, signInWithCustomToken, 
            onAuthStateChanged, createUserWithEmailAndPassword, 
            signInWithEmailAndPassword, signOut
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, doc, setDoc, onSnapshot
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // --- GLOBAL FIREBASE/AUTH VARS ---
        let db = null;
        let auth = null;
        let userId = null;
        let authReady = false; // Flag to indicate auth process is complete
        let saveIntervalId = null; // To hold the save interval reference

        // --- GAME DATA ---
        const UPGRADES = {
            c1: { name: 'Focus Lens', base: 15, mult: 1.5, power: 1, type: 'click' },
            c2: { name: 'Quantum Tap', base: 250, mult: 1.6, power: 15, type: 'click' },
            c3: { name: 'Singularity', base: 5000, mult: 1.8, power: 150, type: 'click' },
            i1: { name: 'Solar Panel', base: 50, mult: 1.4, power: 1, type: 'idle' },
            i2: { name: 'Auto-Miner', base: 500, mult: 1.5, power: 12, type: 'idle' },
            i3: { name: 'Dyson Sphere', base: 10000, mult: 1.6, power: 200, type: 'idle' }
        };
        
        // PETS and RELICS data... (same as before)
        const PETS = [
            { id: 0, name: "Star Wisp", bonus: 0.01, desc: "Your starting companion.", req: "None" },
            { id: 1, name: "Void Golem", bonus: 0.05, desc: "+5% Global Multiplier", req: "Unlock at 10 Stardust" },
            { id: 2, name: "Nebula Jelly", bonus: 0.10, desc: "+10% Global Multiplier", req: "Unlock at 1 Galaxy Shard" },
            { id: 3, name: "Solar Phoenix", bonus: 0.25, desc: "+25% Global Multiplier", req: "Unlock at Prestige Tier 3" }
        ];
        
        const PET_NAMES = ["Drone", "Bot", "Wisp", "Watcher", "Entity", "Hound", "Golem", "Jelly", "Phoenix", "Shade", "Lichen", "Spore"];
        for (let i = 4; i < 54; i++) {
            const nameIndex = i % PET_NAMES.length;
            const sdReq = Math.floor(20 + Math.pow(i - 3, 1.8) * 4);
            const bonus = 0.20 + (i - 3) * 0.05;
            PETS.push({
                id: i,
                name: `Xenon ${PET_NAMES[nameIndex]} ${i-3}`,
                bonus: bonus,
                desc: `+${(bonus * 100).toFixed(1)}% Global Multiplier`,
                req: `Unlock at ${sdReq} Stardust`
            });
        }
        
        const RELICS = [
            { id: 'r1', name: "Quantum Dice", desc: "Small chance for 10x click", icon: "üé≤", hint: "Random drop from clicking", multiplier: { click: 1 } },
            { id: 'r2', name: "Time Hourglass", desc: "Idle gain +20%", icon: "‚è≥", hint: "Random drop from Auto-Clicker", multiplier: { idle: 1.2 } },
            { id: 'r3', name: "Infinity Prism", desc: "Prestige gain +10%", icon: "üíé", hint: "Unlocked at 100 Stardust", multiplier: { prestige: 1.1 } }
        ];

        const ICONS = ["üî≠", "üõ∞Ô∏è", "‚öôÔ∏è", "üõ°Ô∏è", "üîë", "üí°", "üí∞", "üìú", "üîÆ", "ü™®", "‚òÑÔ∏è", "ü™ê", "üåÄ", "üß©", "üß¨", "üåü", "‚ú®", "üåå", "üå†", "‚òÄÔ∏è"];
        const EFFECT_TYPES = ['idle', 'click', 'prestige'];
        
        for (let i = 4; i < 54; i++) {
            const sdReq = i * 25; 
            const effectType = EFFECT_TYPES[i % 3];
            const bonus = 1 + (i * 0.015);
            const multObj = { [effectType]: bonus };
            
            RELICS.push({
                id: `r${i}`,
                name: `Cosmic Shard ${i-3}`,
                desc: `x${bonus.toFixed(2)} ${effectType.toUpperCase()} boost`,
                icon: ICONS[i % ICONS.length],
                hint: `Requires ${sdReq} Stardust to find`,
                multiplier: multObj
            });
        }

        let state = {
            ce: 0, sd: 0, gs: 0, uf: 0,
            upgrades: { c1: 0, c2: 0, c3: 0, i1: 0, i2: 0, i3: 0 },
            relics: [],
            pet: { id: 0, lvl: 1, xp: 0 },
            tutorial: 0, 
        };

        // --- RELIC MULTIPLIER CALCULATOR ---
        function getRelicMultipliers() {
            let mults = { click: 1, idle: 1, prestige: 1 };
            RELICS.forEach(r => {
                if (state.relics.includes(r.id)) {
                    if (r.multiplier.click) mults.click *= r.multiplier.click;
                    if (r.multiplier.idle) mults.idle *= r.multiplier.idle;
                    if (r.multiplier.prestige) mults.prestige *= r.multiplier.prestige;
                }
            });
            return mults;
        }

        // --- LOGIC ---
        function getCPC() {
            let base = 1;
            base += state.upgrades.c1 * UPGRADES.c1.power;
            base += state.upgrades.c2 * UPGRADES.c2.power;
            base += state.upgrades.c3 * UPGRADES.c3.power;
            
            const sdMult = 1 + (state.sd * 0.05);
            const petMult = 1 + (state.pet.lvl * PETS[state.pet.id].bonus);
            const relicMults = getRelicMultipliers();

            return base * sdMult * petMult * relicMults.click;
        }

        function getCPS() {
            let base = 0;
            base += state.upgrades.i1 * UPGRADES.i1.power;
            base += state.upgrades.i2 * UPGRADES.i2.power;
            base += state.upgrades.i3 * UPGRADES.i3.power;
            
            const sdMult = 1 + (state.sd * 0.05);
            const relicMults = getRelicMultipliers();

            return base * sdMult * relicMults.idle;
        }

        // --- ACTIONS ---
        window.clickCore = (e) => {
            let gain = getCPC();
            
            if (state.relics.includes('r1') && Math.random() < 0.05) {
                gain *= 10;
                createFloat("CRIT!", e.clientX, e.clientY - 50, '#facc15');
            }
            
            state.ce += gain;
            state.pet.xp++;
            
            if(state.pet.xp > state.pet.lvl * 100) {
                state.pet.lvl++;
                state.pet.xp = 0;
                showFloatMessage("Pet Level Up!", `Your Pet is now Level ${state.pet.lvl}!`, '#ec4899');
            }

            if(state.tutorial === 1) {
                nextTutorial(true); 
            }

            createFloat(`+${format(gain)}`, e.clientX, e.clientY);
            updateUI();
        };

        window.buyUpgrade = (id) => {
            if (!authReady) return showFloatMessage("Wait", "System still syncing data.", 'yellow');
            const u = UPGRADES[id];
            const cost = Math.floor(u.base * Math.pow(u.mult, state.upgrades[id]));
            if (state.ce >= cost) {
                state.ce -= cost;
                state.upgrades[id]++;
                
                if(state.tutorial === 3 && id === 'c1') {
                    nextTutorial(true); 
                }

                updateUI();
                updateShopButtons();
                window.saveGameToFirestore();
            }
        };
        
        window.doPrestige = (tier) => {
             if (!authReady) return showFloatMessage("Wait", "System still syncing data.", 'yellow');
             if (tier === 1 && state.ce >= 1000000) {
                 const relicMults = getRelicMultipliers();
                 state.sd += Math.floor((state.ce / 1000000) * relicMults.prestige); 
                 state.ce = 0;
                 state.upgrades = { c1: 0, c2: 0, c3: 0, i1: 0, i2: 0, i3: 0 };
                 state.pet.lvl = 1;
                 state.pet.xp = 0;

                 if(state.tutorial === 6) {
                    nextTutorial(true); 
                 }

                 updateUI();
                 window.saveGameToFirestore();
             }
        }
        
        window.equipPet = (id) => {
            if (!authReady) return showFloatMessage("Wait", "System still syncing data.", 'yellow');
            const pet = PETS[id];
            const sdReq = pet.id >= 4 ? PETS[p.id].req.match(/\d+/g)[0] : (pet.id === 1 ? 10 : 0);
            const gsReq = pet.id === 2 ? 1 : 0;
            const unlocked = (p.id === 0) || (state.sd >= sdReq) || (state.gs >= gsReq);

            if (unlocked) {
                state.pet.id = id;

                if(state.tutorial === 4) {
                    if(id === 0) {
                        nextTutorial(true);
                    }
                }

                updateUI();
                window.saveGameToFirestore();
            }
        }

        window.setTab = (id) => {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
            document.getElementById(`tab-${id}`).classList.remove('hidden');
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            document.getElementById(`nav-${id}`).classList.add('active');
            
            // Tutorial tab progression
            if(state.tutorial === 2 && id === 'upgrades') nextTutorial(true);
            if(state.tutorial === 4 && id === 'pets') nextTutorial(true);
            if(state.tutorial === 5 && id === 'relics') nextTutorial(true);
            if(state.tutorial === 6 && id === 'prestige') nextTutorial(true);

            if(id === 'leaderboard') simulateLeaderboard();
        };

        // --- UI ---
        function initShop() {
            const cList = document.getElementById('list-click');
            const iList = document.getElementById('list-idle');
            cList.innerHTML = ''; iList.innerHTML = '';
            
            for (const [k, v] of Object.entries(UPGRADES)) {
                const html = `
                    <div class="shop-item-card" id="card-${k}">
                        <div>
                            <div class="font-bold text-sm text-gray-200">${v.name} <span class="text-xs text-indigo-400" id="lvl-${k}">Lv0</span></div>
                            <div class="text-xs text-gray-500">+${v.power} ${v.type.toUpperCase()}</div>
                        </div>
                        <button id="btn-${k}" class="px-3 py-1 rounded text-xs font-bold btn-push" onclick="window.buyUpgrade('${k}')">
                            Loading...
                        </button>
                    </div>`;
                if (v.type === 'click') cList.innerHTML += html; else iList.innerHTML += html;
            }
        }

        function updateShopButtons() {
            for (const [k, v] of Object.entries(UPGRADES)) {
                const lvl = state.upgrades[k];
                const cost = Math.floor(v.base * Math.pow(v.mult, lvl));
                const canAfford = state.ce >= cost;
                
                const btn = document.getElementById(`btn-${k}`);
                const lvlLabel = document.getElementById(`lvl-${k}`);
                
                if (btn) {
                    btn.innerText = format(cost);
                    btn.className = `px-3 py-1 rounded text-xs font-bold btn-push transition-colors ${canAfford ? 'bg-indigo-600 text-white hover:bg-indigo-500' : 'bg-slate-700 text-gray-500 cursor-not-allowed'}`;
                    btn.disabled = !canAfford || !authReady;
                }
                if (lvlLabel) lvlLabel.innerText = `Lv${lvl}`;
            }
        }

        function updateUI() {
            document.getElementById('disp-ce').innerText = format(state.ce);
            document.getElementById('disp-sd').innerText = format(state.sd);
            document.getElementById('disp-gs').innerText = format(state.gs);
            document.getElementById('disp-cps').innerText = format(getCPS());
            
            const relicMults = getRelicMultipliers();
            const prestigeGain = Math.floor((state.ce / 1000000) * relicMults.prestige);
            document.getElementById('val-sd-gain').innerText = `+${format(prestigeGain)}`;

            updateShopButtons();
            
            // Pet Render
            const petGrid = document.getElementById('pet-grid');
            if (petGrid) {
                petGrid.innerHTML = '';
                PETS.forEach(p => {
                    const sdReq = p.id >= 4 ? PETS[p.id].req.match(/\d+/g)[0] : (p.id === 1 ? 10 : 0);
                    const gsReq = p.id === 2 ? 1 : 0;
                    const unlocked = (p.id === 0) || (state.sd >= sdReq) || (state.gs >= gsReq);
                    const active = state.pet.id === p.id;
                    
                    const petLevelDisplay = active ? `Lv${state.pet.lvl}` : (p.id > 0 ? p.req : 'Active');

                    petGrid.innerHTML += `
                        <div class="bg-slate-800 p-3 rounded border ${active ? 'border-green-500 shadow-md' : (unlocked ? 'border-slate-600 hover:border-indigo-400' : 'border-red-900 opacity-50')} ${unlocked ? 'cursor-pointer' : 'cursor-default'}" onclick="${unlocked ? `window.equipPet(${p.id})` : ''}">
                            <div class="font-bold text-sm ${unlocked ? 'text-white' : 'text-gray-500'}">${p.name}</div>
                            <div class="text-xs text-gray-400">${p.desc}</div>
                            <div class="text-xs font-mono mt-2">${active ? `<span class="text-green-400">ACTIVE: ${petLevelDisplay}</span>` : `<span class="text-indigo-400">${p.req}</span>`}</div>
                        </div>
                    `;
                });
            }
            
            // Relic Render
            const relicGrid = document.getElementById('relic-grid');
            if (relicGrid) {
                relicGrid.innerHTML = '';
                RELICS.forEach(r => {
                    const unlocked = state.relics.includes(r.id);
                    relicGrid.innerHTML += `
                        <div class="bg-slate-800 p-3 rounded border ${unlocked ? 'border-yellow-500 shadow-lg' : 'border-slate-700 opacity-50'}">
                            <div class="text-2xl text-center mb-1">${r.icon}</div>
                            <div class="font-bold text-xs text-center ${unlocked ? 'text-white' : 'text-gray-500'}">${unlocked ? r.name : '???'}</div>
                            <div class="text-[10px] text-center text-gray-400">${unlocked ? r.desc : r.hint}</div>
                        </div>
                    `;
                });
            }
            
            // Relic Drop simulation (Save is triggered in the core click/passive loop)
            if(Math.random() < 0.0005 && authReady) { // Lowered chance
                const availableRelics = RELICS.filter(r => !state.relics.includes(r.id));
                if (availableRelics.length > 0) {
                    const droppedRelic = availableRelics[Math.floor(Math.random() * availableRelics.length)];
                    const requiredSd = parseInt(droppedRelic.hint.match(/\d+/g) || [0])[0];
                    if (state.sd >= requiredSd) { 
                        state.relics.push(droppedRelic.id);
                        showFloatMessage("Relic Found!", `${droppedRelic.name} unlocked!`, '#fbbf24');
                        window.saveGameToFirestore();
                    }
                }
            }
        }

        function format(num) {
            if (num >= 1e18) return (num / 1e18).toFixed(2) + "E";
            if (num >= 1e15) return (num / 1e15).toFixed(2) + "P";
            if (num >= 1e12) return (num / 1e12).toFixed(2) + "T";
            if (num >= 1e9) return (num / 1e9).toFixed(2) + "B";
            if (num >= 1e6) return (num / 1e6).toFixed(2) + "M";
            if (num >= 1e3) return (num / 1e3).toFixed(2) + "K";
            return Math.floor(num).toLocaleString();
        }

        function createFloat(text, x, y, color='#fff') {
            const el = document.createElement('div');
            el.className = 'float-txt';
            el.innerText = text;
            el.style.left = x + 'px';
            el.style.top = y + 'px';
            el.style.color = color;
            document.body.appendChild(el);
            setTimeout(() => el.remove(), 800);
        }

        function showFloatMessage(title, text, color) {
            const el = document.createElement('div');
            el.className = 'fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 glass-panel p-4 rounded-lg z-[200] text-center';
            el.style.color = color;
            el.innerHTML = `<p class="text-xl font-bold">${title}</p><p class="text-sm text-gray-300">${text}</p>`;
            document.body.appendChild(el);
            setTimeout(() => el.remove(), 2500);
        }

        
        function simulateLeaderboard() {
            const list = document.getElementById('leaderboard-list');
            list.innerHTML = '';
            const fakeData = [
                {name: "VoidWalker", val: 1e12},
                {name: "StarLord99", val: 5e9},
                {name: "CosmicCat", val: 1e6},
                {name: "YOU", val: state.ce}
            ];
            fakeData.sort((a,b) => b.val - a.val);
            
            fakeData.forEach((d, i) => {
                 list.innerHTML += `
                    <li class="flex justify-between bg-slate-800 p-2 rounded border-b border-white/5 ${d.name === 'YOU' ? 'border-l-4 border-indigo-500' : ''}">
                        <span class="font-mono text-yellow-500">#${i+1}</span>
                        <span class="text-gray-300 text-xs truncate w-24">${d.name}</span>
                        <span class="text-ce font-bold">${format(d.val)} CE</span>
                    </li>`;
            });
        }

        // --- TUTORIAL ---
        function clearHighlights() {
            document.querySelectorAll('.tutorial-highlight').forEach(el => el.classList.remove('tutorial-highlight'));
        }

        function startTutorial() {
            state.tutorial = 1;
            document.getElementById('core-btn').classList.add('tutorial-highlight');
            showTut("Welcome, Pilot. Click the highlighted <b class='text-indigo-400'>Core</b> repeatedly to generate Cosmic Energy (CE).", false);
        }
        
        window.nextTutorial = (continueInteraction = false) => {
            
            clearHighlights();

            if (continueInteraction) {
                state.tutorial++;
            }
            
            if (state.tutorial === 2) {
                document.getElementById('nav-upgrades').classList.add('tutorial-highlight');
                window.setTab('home'); 
                showTut("Excellent. Now click the highlighted <b class='text-pink-400'>Shop (üõí)</b> tab to see your first available upgrades.", false);
            } else if (state.tutorial === 3) {
                const firstUpgradeButton = document.getElementById('btn-c1');
                if (firstUpgradeButton) firstUpgradeButton.classList.add('tutorial-highlight');
                window.setTab('upgrades'); 
                showTut("Purchase the highlighted <b class='text-pink-400'>Focus Lens</b> to increase your Click Power. You need at least 15 CE.", false);
            } else if (state.tutorial === 4) {
                document.getElementById('nav-pets').classList.add('tutorial-highlight');
                window.setTab('upgrades'); 
                showTut("Every journey needs a partner. Click the highlighted <b class='text-teal-400'>Pets (üëæ)</b> tab. Equip your Star Wisp to complete this step.", false);
            } else if (state.tutorial === 5) {
                document.getElementById('nav-relics').classList.add('tutorial-highlight');
                window.setTab('pets'); 
                showTut("The <b class='text-amber-400'>Relics (üè∫)</b> tab houses Ancient Artifacts. They drop randomly as you play and offer massive bonuses. Click the tab to check it out!", false);
            } else if (state.tutorial === 6) {
                document.getElementById('nav-prestige').classList.add('tutorial-highlight');
                window.setTab('relics'); 
                showTut("When your progress slows, head to <b class='text-purple-400'>Prestige (‚ú®)</b>. Rebirth at 1M CE to gain <b class='text-purple-400'>Stardust</b>. Click the tab.", false);
            } else if (state.tutorial === 7) {
                state.tutorial = 8; 
                window.setTab('prestige'); 
                showTut("You have completed the basic training! Click <b class='text-green-400'>CONTINUE</b> to close the tutorial and begin.", true);
            } else if (state.tutorial === 8) {
                document.getElementById('tutorial-overlay').classList.add('hidden');
                document.getElementById('tutorial-overlay').classList.remove('flex');
                state.tutorial = 99; 
                window.saveGameToFirestore();
                showFloatMessage("Tutorial Complete!", "You are now ready to explore the Cosmic Universe!", '#22d3ee');
            } else {
                if(!continueInteraction) {
                     state.tutorial++;
                     if(state.tutorial > 99) state.tutorial = 99;
                }
            }
        }
        
        function showTut(text, showContinueButton) {
            const overlay = document.getElementById('tutorial-overlay');
            overlay.classList.remove('hidden');
            overlay.classList.add('flex');

            document.getElementById('tut-text').innerHTML = text;
            
            const continueBtn = document.getElementById('tut-continue-btn');
            const actionText = document.getElementById('tut-action-text');

            if (showContinueButton) {
                continueBtn.classList.remove('hidden');
                actionText.classList.add('hidden');
            } else {
                continueBtn.classList.add('hidden');
                actionText.classList.remove('hidden');
                actionText.innerText = "Please interact with the highlighted element in the game to proceed.";
            }
        }

        // --- FIRESTORE SYNC FUNCTIONS ---

        window.saveGameToFirestore = async () => {
            if (!authReady || !userId) return; // Prevent saving before auth is complete
            try {
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                const docRef = doc(db, 'artifacts', appId, 'users', userId, 'gameData', 'state');
                await setDoc(docRef, state);
                const status = document.getElementById('save-status');
                if(status) status.innerText = 'Cloud Saved.';
                setTimeout(() => status.innerText = `Online Ready`, 1000);
            } catch(e) {
                console.error("Could not save to Firestore:", e);
                showFloatMessage("Error", "Cloud save failed!", 'red');
            }
        }
        
        function setupGameSync(appId, uid) {
            const docRef = doc(db, 'artifacts', appId, 'users', uid, 'gameData', 'state');
            
            // Real-time listener for game state
            onSnapshot(docRef, (docSnapshot) => {
                if (docSnapshot.exists()) {
                    // Load saved state from Firestore
                    const savedState = docSnapshot.data();
                    state = { ...state, ...savedState, upgrades: { ...state.upgrades, ...savedState.upgrades } };
                    document.getElementById('save-status').innerText = 'Synced from Cloud';
                } else {
                    // If document doesn't exist (first run for this user), save the default local state
                    window.saveGameToFirestore();
                }
                updateUI();
                
                // If auth is ready, proceed to game setup (only happens once)
                if (!authReady) {
                    authReady = true;
                    // Start the game logic (passive income, etc.)
                    startGameLoops();
                    // Resume tutorial if needed
                    if (state.tutorial > 0 && state.tutorial < 8) {
                        nextTutorial(false); 
                    } else if (state.tutorial === 0) {
                        startTutorial();
                    }
                }
            }, (error) => {
                console.error("Error listening to state changes:", error);
                document.getElementById('save-status').innerText = 'Sync Error!';
            });
        }
        
        // --- FIREBASE & AUTH INIT ---
        async function initFirebaseAndAuth() {
            setLogLevel('Debug');
            const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            
            document.getElementById('loading-message').innerText = 'Authenticating User...';

            return new Promise(resolve => {
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        const isAnon = user.isAnonymous;
                        const email = user.email;
                        
                        document.getElementById('save-status').innerText = `User ID: ${userId} (${isAnon ? 'Anon' : 'Linked'})`;
                        
                        // Set up real-time sync (this calls resolve() when the initial snapshot is received)
                        setupGameSync(appId, userId);
                        
                        // Update UI status
                        updateAccountStatus(isAnon, email);
                        resolve();
                    } else {
                        // Attempt initial sign-in
                        try {
                            const token = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                            if (token) {
                                await signInWithCustomToken(auth, token);
                            } else {
                                await signInAnonymously(auth);
                            }
                        } catch (error) {
                            console.error("Firebase auth failed, signing in anonymously as fallback:", error);
                            await signInAnonymously(auth);
                        }
                    }
                });
            });
        }
        
        // --- AUTH UI LOGIC ---
        function updateAccountStatus(isAnon, email) {
            const statusPanel = document.getElementById('account-status-panel');
            const formPanel = document.getElementById('auth-form-panel');
            
            if (isAnon) {
                statusPanel.className = 'glass-panel p-6 border-l-4 border-yellow-500';
                statusPanel.innerHTML = `
                    <p class="text-xl font-bold text-yellow-400">Anonymous Player</p>
                    <p class="text-lg text-white font-mono text-sm break-all mt-1">ID: ${userId}</p>
                    <p class="text-sm text-gray-300 mt-2">Your progress is tied to this session. Link an email to save it permanently across devices.</p>
                `;
                if (formPanel) formPanel.classList.remove('hidden');
                const authBtn = document.getElementById('auth-button');
                if (authBtn) {
                     authBtn.innerText = 'Link Email & Save';
                     authBtn.classList.replace('bg-indigo-600', 'bg-green-600');
                }
            } else if (email) {
                statusPanel.className = 'glass-panel p-6 border-l-4 border-green-500';
                statusPanel.innerHTML = `
                    <p class="text-xl font-bold text-green-400">Account Linked</p>
                    <p class="text-lg text-white font-mono mt-2 break-all">${email}</p>
                    <p class="text-sm text-gray-300 mt-2">Your progress is safely stored in the cloud.</p>
                    <button class="btn-push bg-red-600 hover:bg-red-500 text-white text-xs mt-4 px-3 py-1 rounded" onclick="window.handleSignOut()">Sign Out</button>
                `;
                if (formPanel) formPanel.classList.add('hidden');
            }
        }
        
        window.handleAuth = async (event) => {
            event.preventDefault();
            const email = document.getElementById('email-input').value;
            const password = document.getElementById('password-input').value;
            
            if (!email || !password) {
                showFloatMessage("Error", "Please enter both email and password.", 'red');
                return;
            }

            const btn = document.getElementById('auth-button');
            const originalText = btn.innerText;
            btn.disabled = true;
            btn.innerText = "Processing...";
            
            try {
                if (auth.currentUser && auth.currentUser.isAnonymous) {
                    // Try to create a new user and sign in
                    await createUserWithEmailAndPassword(auth, email, password);
                    showFloatMessage("Success", "Account created and progress linked!", 'green');
                } else {
                    // Try to sign in with existing credentials
                    await signInWithEmailAndPassword(auth, email, password);
                    showFloatMessage("Success", "Signed in! Your cloud progress is loaded.", 'green');
                }
            } catch (error) {
                console.error("Auth Error:", error.code, error.message);
                
                if (error.code === 'auth/email-already-in-use') {
                    // If email is in use, try to sign in
                    try {
                        await signInWithEmailAndPassword(auth, email, password);
                        showFloatMessage("Success", "Signed in with existing account!", 'green');
                    } catch(e) {
                         showFloatMessage("Error", "Email exists, but password was incorrect.", 'red');
                    }
                } else if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password' || error.code === 'auth/invalid-credential') {
                    showFloatMessage("Error", "Invalid email or password.", 'red');
                } else if (error.code === 'auth/weak-password') {
                    showFloatMessage("Error", "Password must be at least 6 characters.", 'red');
                } else {
                     showFloatMessage("Error", "Authentication failed. Check console.", 'red');
                }
            } finally {
                btn.disabled = false;
                btn.innerText = originalText;
            }
        }
        
        window.handleSignOut = async () => {
             if (auth) {
                 await signOut(auth);
                 // onAuthStateChanged will handle the sign out and sign the user back in anonymously
                 showFloatMessage("Signed Out", "You are now playing anonymously.", 'yellow');
             }
        }


        // --- INITIALIZATION ---

        function startGameLoops() {
             if(saveIntervalId) clearInterval(saveIntervalId);
            // Passive income loop
            setInterval(() => {
                if (authReady) {
                    state.ce += getCPS() / 10;
                    updateUI();
                }
            }, 100);

            // Auto-save loop (Cloud save every 5 seconds)
            saveIntervalId = setInterval(window.saveGameToFirestore, 5000);
            
            // Set initial tab 
            window.setTab('home');

            // Fade out the loading screen
            const loadingScreen = document.getElementById('app-loading-screen');
            const body = document.body;
            loadingScreen.style.opacity = '0';
            
            setTimeout(() => {
                loadingScreen.style.display = 'none';
                body.classList.add('loaded'); // Reveal the body content
            }, 500); 
        }
        
        // Renamed and isolated the core app startup logic
        async function loadGameDataAndStartApp() {
            initShop();
            await initFirebaseAndAuth();
            // Execution continues in setupGameSync once the first snapshot is received
            
            // Generate icon asynchronously
            generateAnimeIcon();
        }

        async function generateAnimeIcon() {
            const prompt = "A high-resolution, anime-style icon for a cosmic universal idle game. The design should feature a cute, stylized black hole or a glowing atomic core, surrounded by sparkling stardust and a determined, chibi-style pilot character floating nearby. Digital art, vibrant colors, clean lines.";
            const payload = { 
                instances: { prompt: prompt }, 
                parameters: { "sampleCount": 1 } 
            };
            const apiKey = ""; 
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/imagen-4.0-generate-001:predict?key=${apiKey}`;
            
            const spinner = document.getElementById('icon-spinner');
            const iconImg = document.getElementById('app-icon');
            
            let retries = 0;
            const maxRetries = 5;
            const delay = (ms) => new Promise(resolve => setTimeout(resolve, ms));

            while (retries < maxRetries) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    
                    const result = await response.json();
                    
                    if (result.predictions && result.predictions.length > 0 && result.predictions[0].bytesBase64Encoded) {
                        const base64Data = result.predictions[0].bytesBase64Encoded;
                        const imageUrl = `data:image/png;base64,${base64Data}`;
                        
                        spinner.classList.add('hidden');
                        iconImg.src = imageUrl;
                        iconImg.classList.remove('hidden');
                        return;
                    } else {
                        console.error("Image generation failed: No base64 data received.");
                    }
                } catch (error) {
                    retries++;
                    if (retries >= maxRetries) {
                        console.error("Failed to generate icon after multiple retries:", error);
                        spinner.innerHTML = 'Icon Failed ‚ùå';
                        return;
                    }
                    await delay(Math.pow(2, retries) * 1000); // Exponential backoff
                }
            }
        }

        window.onload = loadGameDataAndStartApp;
    </script>
</body>
</html>
