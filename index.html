<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cosmic Gem Clicker</title>
    <!-- Essential PWA Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="manifest" href="manifest.json">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* General Layout & Colors */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0D1117; /* Dark background */
            color: #E6E8EA; /* Light text */
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center; /* Center the game content vertically */
            padding-top: 1rem;
        }
        .game-container {
            max-width: 1000px;
            width: 95%;
            padding: 0; /* Remove padding here to maximize space for internal elements */
            margin: auto;
            min-height: 90vh; 
        }
        .dark-card {
            background-color: #161B22; 
            border-radius: 0.75rem;
            padding: 1rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }
        
        /* Interactive Elements */
        .accent-button {
            background-color: #58a6ff;
            color: #0D1117;
            font-weight: 700;
            transition: all 0.1s;
        }
        .accent-button:hover:not(:disabled) { background-color: #79c0ff; }
        
        /* Upgrade Card Styling - Increased padding for easier mobile tapping */
        .upgrade-card {
            background-color: #221515; 
            transition: transform 0.1s;
        }
        .upgrade-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 10px rgba(0, 0, 0, 0.5);
        }
        
        /* Click Source Styling - Always prominent */
        .source-circle {
            width: 180px; /* Slightly larger for mobile tap target */
            height: 180px;
            background: linear-gradient(135deg, #ff8c00 0%, #ff4500 100%);
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 0 25px rgba(255, 69, 0, 0.9);
            transition: transform 0.1s, box-shadow 0.2s;
            display: flex;
            justify-content: center;
            align-items: center;
            /* Center the circle horizontally on mobile */
            margin-left: auto;
            margin-right: auto;
        }
        .source-circle:active {
            transform: scale(0.92);
            box-shadow: 0 0 15px rgba(255, 69, 0, 1);
        }
        .gem-icon {
            font-size: 4rem;
            color: #58a6ff;
            text-shadow: 0 0 15px rgba(88, 166, 255, 0.9);
        }
        
        /* Mobile-first button styling */
        .tab-button {
             flex-grow: 1; /* Make tabs equally wide on mobile */
             text-align: center;
             padding: 1rem;
             font-size: 1.1rem;
        }
    </style>
</head>
<body class="p-4">

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        setLogLevel('Debug');

        // Global variables provided by the environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'cosmic-gem-clicker-default';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app, db, auth;
        let userId = 'loading';
        let isAuthReady = false;
        let unsubscribeGameState = null;

        // Game State Management
        let gameState = {
            gems: 0,
            crystals: 0,
            clickPower: 1.0,
            minerLevel: 0,
            autoClickerLevel: 0,
            prestigeCount: 0,
            tutorialComplete: true,
            currentTab: 'gems' 
        };

        const PRESTIGE_THRESHOLD = 50000; 

        const GEM_COSTS = {
            click: (level) => Math.floor(10 * Math.pow(1.5, level)),
            miner: (level) => Math.floor(50 * Math.pow(2, level)),
            autoclicker: (level) => Math.floor(1000 * Math.pow(3, level)),
        };
        
        // --- Tab Management ---
        function switchTab(tabName) {
            gameState.currentTab = tabName;
            updateUI();
        }

        function getGemsPerSecond() {
            let minerRate = gameState.minerLevel * 0.1;
            let autoclickerRate = gameState.autoClickerLevel * gameState.clickPower * 1;
            
            // Apply prestige bonus: +1% income per crystal
            const prestigeMultiplier = 1 + (gameState.crystals * 0.01);

            return (minerRate + autoclickerRate) * prestigeMultiplier;
        }
        
        function calculateCrystalsOnPrestige() {
            if (gameState.gems < PRESTIGE_THRESHOLD) return 0;
            return Math.floor((gameState.gems - PRESTIGE_THRESHOLD) / 50000) + 1;
        }

        // UI Update Functions
        const $ = id => document.getElementById(id);

        function updateUI() {
            // --- RESOURCE DISPLAY ---
            const gps = getGemsPerSecond();
            $('gems-amount').textContent = gameState.gems.toFixed(2);
            $('gems-rate').textContent = `Rate: ${gps.toFixed(2)} G/sec (x${(1 + (gameState.crystals * 0.01)).toFixed(2)} Multiplier)`;
            $('crystals-amount').textContent = gameState.crystals.toFixed(0);
            $('crystals-rate').textContent = `Total Prestige Runs: ${gameState.prestigeCount}`;
            $('player-id').textContent = userId;
            $('player-id-footer').textContent = userId;

            // --- TAB VISIBILITY & STYLING ---
            const isGemsTab = gameState.currentTab === 'gems';
            $('upgrades-gems').classList.toggle('hidden', !isGemsTab);
            $('upgrades-prestige').classList.toggle('hidden', isGemsTab);
            
            // Tab button styling
            $('tab-gems').classList.toggle('accent-button', isGemsTab);
            $('tab-gems').classList.toggle('bg-[#161B22]', !isGemsTab);
            $('tab-gems').classList.toggle('text-gray-400', !isGemsTab);

            $('tab-prestige').classList.toggle('accent-button', !isGemsTab);
            $('tab-prestige').classList.toggle('bg-[#161B22]', isGemsTab);
            $('tab-prestige').classList.toggle('text-gray-400', isGemsTab);


            // --- GEM UPGRADES CONTENT ---
            if (isGemsTab) {
                $('click-power').textContent = gameState.clickPower.toFixed(2);

                // Enhance Click Power
                const nextClickCost = GEM_COSTS.click(gameState.clickPower - 1);
                $('enhance-level').textContent = `(Lvl ${gameState.clickPower.toFixed(0)})`;
                $('enhance-cost').textContent = nextClickCost.toLocaleString();
                $('enhance-buy').disabled = gameState.gems < nextClickCost;

                // Miner
                const nextMinerCost = GEM_COSTS.miner(gameState.minerLevel);
                $('miner-level').textContent = `(Lvl ${gameState.minerLevel})`;
                $('miner-cost').textContent = nextMinerCost.toLocaleString();
                $('miner-income').textContent = `Generates ${ (gameState.minerLevel * 0.1).toFixed(2) } G/sec base.`;
                $('miner-buy').disabled = gameState.gems < nextMinerCost;

                // Auto-Clicker
                const nextAutoClickerCost = GEM_COSTS.autoclicker(gameState.autoClickerLevel);
                $('autoclicker-level').textContent = `(Lvl ${gameState.autoClickerLevel})`;
                $('autoclicker-cost').textContent = nextAutoClickerCost.toLocaleString();
                $('autoclicker-income').textContent = `Simulates ${gameState.autoClickerLevel} clicks per second.`;
                $('autoclicker-buy').disabled = gameState.gems < nextAutoClickerCost;

            } 
            // --- PRESTIGE CONTENT ---
            else {
                const newCrystals = calculateCrystalsOnPrestige();
                $('prestige-new-crystals').textContent = newCrystals;
                $('prestige-current-gems').textContent = gameState.gems.toFixed(0);
                $('current-crystals-display').textContent = gameState.crystals.toFixed(0);
                $('prestige-count-display').textContent = gameState.prestigeCount;
                
                const isReady = newCrystals > 0;
                $('prestige-btn').disabled = !isReady;
                $('prestige-requirement-text').classList.toggle('text-green-500', isReady);
                $('prestige-requirement-text').classList.toggle('text-red-500', !isReady);
            }
        }

        // Game Logic Functions
        function clickGem() {
            gameState.gems += gameState.clickPower;
            updateUI();
            saveGameState(); 
        }

        function buyUpgrade(type) {
            let cost;
            if (type === 'click') {
                cost = GEM_COSTS.click(gameState.clickPower - 1);
                if (gameState.gems >= cost) {
                    gameState.gems -= cost;
                    gameState.clickPower += 1.00;
                }
            } else if (type === 'miner') {
                cost = GEM_COSTS.miner(gameState.minerLevel);
                if (gameState.gems >= cost) {
                    gameState.gems -= cost;
                    gameState.minerLevel += 1;
                }
            } else if (type === 'autoclicker') {
                cost = GEM_COSTS.autoclicker(gameState.autoClickerLevel);
                if (gameState.gems >= cost) {
                    gameState.gems -= cost;
                    gameState.autoClickerLevel += 1;
                }
            }
            updateUI();
            saveGameState();
        }
        
        function performPrestige() {
            const newCrystals = calculateCrystalsOnPrestige();
            if (newCrystals > 0) {
                // 1. Gain Crystals
                gameState.crystals += newCrystals;
                gameState.prestigeCount += 1;
                
                // 2. Reset Gem State (keep crystals and prestige count)
                gameState.gems = 0;
                gameState.clickPower = 1.0;
                gameState.minerLevel = 0;
                gameState.autoClickerLevel = 0;
                
                // 3. Save and Update UI
                updateUI();
                saveGameState();
            } else {
                console.warn("Prestige failed: Not enough gems.");
            }
        }

        // Firebase Functions
        function getGameStateRef(id) {
            return doc(db, 'artifacts', appId, 'users', id, 'gameData', 'state');
        }

        async function saveGameState() {
            if (!isAuthReady || !userId || !db) return;
            try {
                await setDoc(getGameStateRef(userId), gameState, { merge: true });
            } catch (e) {
                console.error("Error saving document: ", e);
            }
        }

        function loadGameState(id) {
            if (unsubscribeGameState) {
                unsubscribeGameState(); 
            }

            unsubscribeGameState = onSnapshot(getGameStateRef(id), (docSnapshot) => {
                if (docSnapshot.exists()) {
                    const loadedState = docSnapshot.data();
                    gameState = { ...gameState, ...loadedState }; 
                } else {
                    console.log("No existing game state found. Using initial state.");
                }
                updateUI();
            }, (error) => {
                console.error("Error listening to game state:", error);
            });
        }

        // Game Loop (for passive income)
        let lastUpdate = Date.now();
        function gameLoop() {
            const now = Date.now();
            const deltaTime = (now - lastUpdate) / 1000; 
            lastUpdate = now;

            if (isAuthReady) {
                const income = getGemsPerSecond() * deltaTime;
                gameState.gems += income;

                updateUI();
            }

            requestAnimationFrame(gameLoop);
        }

        // PWA & Auth Setup
        async function initApp() {
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                await new Promise((resolve) => {
                    onAuthStateChanged(auth, async (user) => {
                        if (user) {
                            userId = user.uid;
                        } else {
                            if (initialAuthToken) {
                                await signInWithCustomToken(auth, initialAuthToken);
                                userId = auth.currentUser.uid;
                            } else {
                                await signInAnonymously(auth);
                                userId = auth.currentUser.uid;
                            }
                        }
                        isAuthReady = true;
                        resolve();
                    });
                });

                loadGameState(userId);
                gameLoop(); 

                // Event Listeners
                $('source-circle').addEventListener('click', clickGem);
                $('enhance-buy').addEventListener('click', () => buyUpgrade('click'));
                $('miner-buy').addEventListener('click', () => buyUpgrade('miner'));
                $('autoclicker-buy').addEventListener('click', () => buyUpgrade('autoclicker'));
                
                // Tab Listeners
                $('tab-gems').addEventListener('click', () => switchTab('gems'));
                $('tab-prestige').addEventListener('click', () => switchTab('prestige'));
                
                // Prestige Listener
                $('prestige-btn').addEventListener('click', performPrestige);

                updateUI();

            } catch (error) {
                console.error("Firebase/App Initialization Error:", error);
            }
        }

        window.onload = () => {
            initApp();

            // PWA Service Worker Registration
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('service-worker.js')
                    .then((reg) => console.log('Service Worker Registered (scope: ' + reg.scope + ')'))
                    .catch((err) => console.log('Service Worker Registration Failed:', err));
            }
        };

    </script>


    <div class="game-container p-4">
        <h1 class="text-4xl font-extrabold text-center mb-4" style="color: #ff8c00; text-shadow: 0 0 10px rgba(255, 140, 0, 0.5);">Cosmic Gem Clicker</h1>
        <p id="player-id-display" class="text-center text-sm mb-6 text-gray-500">Player ID: <span id="player-id">Loading...</span></p>

        <!-- Resources Section (ALWAYS 2 columns on ALL devices) -->
        <div class="grid grid-cols-2 gap-4 mb-6">
            <!-- Gems Card -->
            <div class="dark-card">
                <h2 class="text-lg sm:text-xl font-bold mb-1" style="color: #58a6ff;">Gems</h2>
                <div class="text-4xl sm:text-5xl font-extrabold" id="gems-amount">0.00</div>
                <p class="text-gray-400 mt-1 text-xs sm:text-sm" id="gems-rate">Rate: 0.00 G/sec</p>
            </div>

            <!-- Crystals Card -->
            <div class="dark-card">
                <h2 class="text-lg sm:text-xl font-bold mb-1" style="color: #6a5acd;">Crystals</h2>
                <div class="text-4xl sm:text-5xl font-extrabold" id="crystals-amount">0</div>
                <p class="text-gray-400 mt-1 text-xs sm:text-sm" id="crystals-rate">Total Prestige Runs: 0</p>
            </div>
        </div>

        <!-- Main Game Area (Clicker & Upgrades - Stacks on mobile) -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">

            <!-- Click Source Section (Always full width on mobile) -->
            <div class="dark-card col-span-1 flex flex-col items-center p-6 lg:p-4">
                <h2 class="text-xl font-bold mb-4">The Source</h2>
                <p class="text-lg mb-4 text-gray-300">Click Power: <span id="click-power">1.00</span> G/Click</p>

                <div id="source-circle" class="source-circle mb-4 flex-shrink-0">
                    <span class="gem-icon">ðŸ’Ž</span>
                </div>
                <p class="text-sm text-gray-500">Manual Click Income</p>
            </div>

            <!-- Upgrades Tab Selector & Content (Stacks under the clicker on mobile) -->
            <div class="lg:col-span-2">
                <!-- Tab Buttons - MUST be full width and equally sized -->
                <div class="flex mb-4 rounded-t-lg overflow-hidden">
                    <button id="tab-gems" class="tab-button font-bold rounded-none">Gem Upgrades</button>
                    <button id="tab-prestige" class="tab-button font-bold rounded-none">Crystals & Prestige</button>
                </div>

                <!-- Upgrades Content CONTAINER -->
                <div class="dark-card">
                    <!-- Gem Upgrades Panel (Initially visible) -->
                    <div id="upgrades-gems">
                        <!-- Click Upgrades -->
                        <div class="mb-6">
                            <h3 class="text-2xl font-bold mb-4" style="color: #58a6ff;">Click Upgrades</h3>
                            <div id="click-upgrade" class="upgrade-card flex flex-col sm:flex-row justify-between items-center p-4 rounded-lg space-y-2 sm:space-y-0">
                                <div class="w-full sm:w-auto">
                                    <h4 class="text-lg font-semibold text-white">Enhance Click Power <span id="enhance-level" class="text-sm text-gray-400">(Lvl 1)</span></h4>
                                    <p class="text-sm text-gray-400">Increases GEMS per click by 1.00.</p>
                                </div>
                                <div class="flex items-center space-x-2 w-full sm:w-auto justify-end">
                                    <span id="enhance-cost" class="font-bold text-xl text-yellow-400">10</span>
                                    <span class="font-bold text-lg text-yellow-400">G</span>
                                    <button id="enhance-buy" class="px-5 py-3 text-lg bg-green-600 rounded-lg font-bold hover:bg-green-700 disabled:opacity-50 disabled:cursor-not-allowed min-w-[100px]">Buy</button>
                                </div>
                            </div>
                        </div>

                        <!-- Automation Panel -->
                        <div>
                            <h3 class="text-2xl font-bold mb-4" style="color: #58a6ff;">Automation</h3>
                            <div class="space-y-4">
                                <!-- New Gem Miner -->
                                <div id="miner-upgrade" class="upgrade-card flex flex-col sm:flex-row justify-between items-center p-4 rounded-lg space-y-2 sm:space-y-0">
                                    <div class="w-full sm:w-auto">
                                        <h4 class="text-lg font-semibold text-white">Buy New Gem Miner <span id="miner-level" class="text-sm text-gray-400">(Lvl 0)</span></h4>
                                        <p id="miner-income" class="text-sm text-gray-400">Generates 0.00 G/sec base.</p>
                                    </div>
                                    <div class="flex items-center space-x-2 w-full sm:w-auto justify-end">
                                        <span id="miner-cost" class="font-bold text-xl text-yellow-400">50</span>
                                        <span class="font-bold text-lg text-yellow-400">G</span>
                                        <button id="miner-buy" class="px-5 py-3 text-lg bg-green-600 rounded-lg font-bold hover:bg-green-700 disabled:opacity-50 disabled:cursor-not-allowed min-w-[100px]">Buy</button>
                                    </div>
                                </div>
                                <!-- Auto-Clicker -->
                                <div id="autoclicker-upgrade" class="upgrade-card flex flex-col sm:flex-row justify-between items-center p-4 rounded-lg space-y-2 sm:space-y-0">
                                    <div class="w-full sm:w-auto">
                                        <h4 class="text-lg font-semibold text-white">Auto-Clicker <span id="autoclicker-level" class="text-sm text-gray-400">(Lvl 0)</span></h4>
                                        <p id="autoclicker-income" class="text-sm text-gray-400">Simulates 0 clicks per second.</p>
                                    </div>
                                    <div class="flex items-center space-x-2 w-full sm:w-auto justify-end">
                                        <span id="autoclicker-cost" class="font-bold text-xl text-yellow-400">1,000</span>
                                        <span class="font-bold text-lg text-yellow-400">G</span>
                                        <button id="autoclicker-buy" class="px-5 py-3 text-lg bg-green-600 rounded-lg font-bold hover:bg-green-700 disabled:opacity-50 disabled:cursor-not-allowed min-w-[100px]">Buy</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Prestige Upgrades Panel (Initially hidden) -->
                    <div id="upgrades-prestige" class="hidden text-center p-6">
                        <h3 class="text-2xl font-bold mb-4" style="color: #6a5acd;">Prestige Protocol</h3>
                        <p class="text-lg mb-6 text-gray-300">
                            Prestige resets your Gems and Upgrades, but grants permanent Crystals.
                            Each Crystal increases all future Gem generation by <span class="font-bold text-green-400">1%</span>.
                        </p>
                        
                        <div class="mb-8 p-4 border border-gray-700 rounded-lg">
                            <p class="text-xl font-semibold mb-2">Gems Earned This Run: <span id="prestige-current-gems" class="text-yellow-400">0</span></p>
                            <p id="prestige-requirement-text" class="text-sm mb-4 text-red-500 font-bold">Requirement: 50,000 Gems</p>
                            
                            <p class="text-3xl font-extrabold mb-6">
                                New Crystals to Earn: <span id="prestige-new-crystals">0</span> ðŸ’Ž
                            </p>
                            
                            <button id="prestige-btn" class="w-full px-8 py-4 rounded-xl font-extrabold text-xl disabled:opacity-50 disabled:cursor-not-allowed bg-[#6a5acd] text-white hover:bg-[#8378d3] transition">
                                Initiate Prestige & Reset
                            </button>
                        </div>
                        
                        <p class="text-sm text-gray-500">Current Crystals: <span class="text-white font-bold" id="current-crystals-display">0</span> | Total Prestige Runs: <span class="text-white font-bold" id="prestige-count-display">0</span></p>
                    </div>
                </div>
            </div>
        </div>

        <p class="text-center text-xs text-gray-600 mt-8 mb-4">
            Game State Version 2.4 | Real-time Persistence via Firestore (ID: <span id="player-id-footer">Loading...</span>)
        </p>

    </div>
</body>
</html>
